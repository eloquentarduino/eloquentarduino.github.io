<!DOCTYPE html>
<html lang="en-US"><head profile="http://gmpg.org/xfn/11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta property="og:title" content="Apple or Orange? Image recognition with ESP32 and Arduino"><meta property="og:description" content="Do you have an ESP32 camera? 
Want to do image recognition directly on your ESP32, without a PC?
In this post we'll look into a very basic image recognition tas"><meta property="og:image" content="https://eloquentarduino.github.io/wp-content/uploads/2020/01/Apple-vs-Orange.gif"><meta property="og:image:width" content="600"><meta property="og:image:height" content="338"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Apple or Orange? Image recognition with ESP32 and Arduino"><meta name="twitter:description" content="Do you have an ESP32 camera? 
Want to do image recognition directly on your ESP32, without a PC?
In this post we'll look into a very basic image recognition tas"><meta name="twitter:image" content="https://eloquentarduino.github.io/wp-content/uploads/2020/01/Apple-vs-Orange.gif"><meta name="author" content="simone"><link rel="stylesheet" media="print" onload="this.onload=null;this.media='all';" id="ao_optimized_gfonts" href="https://fonts.googleapis.com/css?family=Lato%3A400%2C700%2C400italic%2C700italic%7CLato:400,700&display=swap"><link media="all" href="https://eloquentarduino.github.io/wp-content/cache/autoptimize/css/autoptimize_1ba47c6384743b421dea1c84fa98c2fe.css" rel="stylesheet"><title>Apple or Orange? Image recognition with ESP32 and Arduino</title><meta name="robots" content="index, follow"><meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/"><meta property="og:site_name" content="Eloquent Arduino Blog"><meta property="article:published_time" content="2020-01-12T10:32:08+00:00"><meta property="article:modified_time" content="2020-05-31T16:51:27+00:00"><meta property="og:image" content="https://eloquentarduino.github.io/wp-content/uploads/2020/01/Apple-vs-Orange.gif"><meta property="og:image:width" content="600"><meta property="og:image:height" content="338"> <script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://eloquentarduino.github.io/#website","url":"https://eloquentarduino.github.io/","name":"Eloquent Arduino Blog","description":"Machine learning on Arduino, programming & electronics","publisher":{"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901"},"potentialAction":[{"@type":"SearchAction","target":"https://eloquentarduino.github.io/?s={search_term_string}","query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/#primaryimage","inLanguage":"en-US","url":"/wp-content/uploads/2020/01/Apple-vs-Orange.gif"},{"@type":"WebPage","@id":"https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/#webpage","url":"https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/","name":"Apple or Orange? Image recognition with ESP32 and Arduino","isPartOf":{"@id":"https://eloquentarduino.github.io/#website"},"primaryImageOfPage":{"@id":"https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/#primaryimage"},"datePublished":"2020-01-12T10:32:08+00:00","dateModified":"2020-05-31T16:51:27+00:00","inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/"]}]},{"@type":"Article","@id":"https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/#article","isPartOf":{"@id":"https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/#webpage"},"author":{"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901"},"headline":"Apple or Orange? Image recognition with ESP32 and Arduino","datePublished":"2020-01-12T10:32:08+00:00","dateModified":"2020-05-31T16:51:27+00:00","mainEntityOfPage":{"@id":"https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/#webpage"},"publisher":{"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901"},"image":{"@id":"https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/#primaryimage"},"keywords":"camera,esp32,microml,svm","articleSection":"Arduino Machine learning,Computer vision","inLanguage":"en-US"},{"@type":["Person","Organization"],"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901","name":"simone","image":{"@type":"ImageObject","@id":"https://eloquentarduino.github.io/#personlogo","inLanguage":"en-US","url":"https://eloquentarduino.github.io/wp-content/uploads/2019/12/avatar.jpg","width":330,"height":330,"caption":"simone"},"logo":{"@id":"https://eloquentarduino.github.io/#personlogo"}}]}</script> <link rel="dns-prefetch" href="//use.fontawesome.com"><link rel="dns-prefetch" href="//s.w.org"><link href="https://fonts.gstatic.com" crossorigin="anonymous" rel="preconnect"><link rel="stylesheet" id="font-awesome-official-css" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css" type="text/css" media="all" integrity="sha384-REHJTs1r2ErKBuJB0fCK99gCYsVjwxHrSU0N7I1zl9vZbggVJXRMsv/sLlOAGb4M" crossorigin="anonymous"><link rel="stylesheet" id="font-awesome-official-v4shim-css" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css" type="text/css" media="all" integrity="sha384-AL44/7DEVqkvY9j8IjGLGZgFmHAjuHa+2RIWKxDliMNIfSs9g14/BRpYwHrWQgz6" crossorigin="anonymous"> <script type="text/javascript" src="https://eloquentarduino.github.io/wp-includes/js/jquery/jquery.js"></script> <meta name="google-site-verification" content="xgigjPrbbYDemskTaGLT9WGhmw8wgdeFtpDxVak0awI"></head><body class="post-template-default single single-post postid-820 single-format-standard has-body"><div class="wrapper"><div class="sidebar"><div class="blog-header"> <a class="blog-logo" href="https://eloquentarduino.github.io" title="Eloquent Arduino Blog — Machine learning on Arduino, programming & electronics" rel="home"> <noscript><img src="https://eloquentarduino.github.io/wp-content/uploads/2019/12/logo-completo.png" alt="Eloquent Arduino Blog"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="https://eloquentarduino.github.io/wp-content/uploads/2019/12/logo-completo.png" alt="Eloquent Arduino Blog"> </a></div><div class="nav-toggle toggle"><p> <span class="show">Show menu</span> <span class="hide">Hide menu</span></p><div class="bars"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="clear"></div></div></div><div class="blog-menu"><ul class="navigation"><li id="menu-item-461" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-461"><a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/">Arduino Machine learning</a></li><li id="menu-item-462" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-462"><a href="https://eloquentarduino.github.io/category/programming/eloquent-library/">Eloquent library</a></li></ul><div class="clear"></div></div><div class="mobile-menu"><ul class="navigation"><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-461"><a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/">Arduino Machine learning</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-462"><a href="https://eloquentarduino.github.io/category/programming/eloquent-library/">Eloquent library</a></li></ul></div><div class="widgets" role="complementary"><div class="widget_text widget widget_custom_html"><div class="widget_text widget-content"><div class="textwidget custom-html-widget"><div style="text-align: center"> <noscript><img src="/wp-content/uploads/2020/04/profilo.png" alt="Profile pic" style="width: 125px"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2020/04/profilo.png" alt="Profile pic" style="width: 125px"> <a href="/about-me" style="display: block; font-size: 18px">About me</a></div></div></div><div class="clear"></div></div><div class="widget widget_search"><div class="widget-content"><form method="get" class="searchform" action="https://eloquentarduino.github.io" id="searchform"><div role="search" class="searchbox__wrapper"> <input id="search-input" type="search" name="search" placeholder="Search the blog" autocomplete="off" required="required" class="searchbox__input"> <button type="submit" title="Submit your search query." class="searchbox__submit"> <svg role="img" aria-label="Search"> <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#sbx-icon-search-13"></use> </svg> </button> <button type="reset" title="Clear the search query." class="searchbox__reset hide"> <svg role="img" aria-label="Reset"> <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#sbx-icon-clear-3"></use> </svg> </button></div></form></div><div class="clear"></div></div><div class="widget widget_recent_entries"><div class="widget-content"><h3 class="widget-title">Recent Posts</h3><ul><li> <a href="https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/">TinyML on Arduino and STM32: CNN (Convolutional Neural Network) example</a></li><li> <a href="https://eloquentarduino.github.io/2020/10/decision-tree-random-forest-and-xgboost-on-arduino/">Decision Tree, Random Forest and XGBoost on Arduino</a></li><li> <a href="https://eloquentarduino.github.io/2020/09/principal-fft-components-as-efficient-features-extrator/">“Principal” FFT components as efficient features extrator</a></li><li> <a href="https://eloquentarduino.github.io/2020/08/better-word-classification-with-arduino-33-ble-sense-and-machine-learning/">Better word classification with Arduino Nano 33 BLE Sense and Machine Learning</a></li><li> <a href="https://eloquentarduino.github.io/2020/08/the-ultimate-guide-to-wifi-indoor-positioning-using-arduino-and-machine-learning/">The Ultimate Guide to Wifi Indoor Positioning using Arduino and Machine Learning</a></li></ul></div><div class="clear"></div></div><div class="widget widget_sub_categories"><div class="widget-content"><h3 class="widget-title">Programming</h3><ul><li class="cat-item cat-item-8"><a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/">Arduino Machine learning</a><ul class="children"><li class="cat-item cat-item-24"><a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/arduino-machine-learning-tutorial/">Arduino Machine Learning tutorial</a></li></ul></li><li class="cat-item cat-item-12"><a href="https://eloquentarduino.github.io/category/programming/computer-vision/">Computer vision</a></li><li class="cat-item cat-item-7"><a href="https://eloquentarduino.github.io/category/programming/eloquent-library/">Eloquent library</a></li></ul></div><div class="clear"></div></div><div class="widget widget_tag_cloud"><div class="widget-content"><h3 class="widget-title">TAGS</h3><div class="tagcloud"><a href="https://eloquentarduino.github.io/tag/camera/" class="tag-cloud-link tag-link-11 tag-link-position-1" style="font-size: 14.222222222222pt;" aria-label="camera (5 items)">camera</a> <a href="https://eloquentarduino.github.io/tag/eloquent/" class="tag-cloud-link tag-link-4 tag-link-position-2" style="font-size: 11.888888888889pt;" aria-label="eloquent (3 items)">eloquent</a> <a href="https://eloquentarduino.github.io/tag/esp32/" class="tag-cloud-link tag-link-10 tag-link-position-3" style="font-size: 14.222222222222pt;" aria-label="esp32 (5 items)">esp32</a> <a href="https://eloquentarduino.github.io/tag/incremental-learning/" class="tag-cloud-link tag-link-16 tag-link-position-4" style="font-size: 8pt;" aria-label="incremental-learning (1 item)">incremental-learning</a> <a href="https://eloquentarduino.github.io/tag/microml/" class="tag-cloud-link tag-link-5 tag-link-position-5" style="font-size: 22pt;" aria-label="microml (23 items)">microml</a> <a href="https://eloquentarduino.github.io/tag/ml/" class="tag-cloud-link tag-link-17 tag-link-position-6" style="font-size: 14.222222222222pt;" aria-label="ml (5 items)">ml</a> <a href="https://eloquentarduino.github.io/tag/online-learning/" class="tag-cloud-link tag-link-15 tag-link-position-7" style="font-size: 10.333333333333pt;" aria-label="online-learning (2 items)">online-learning</a> <a href="https://eloquentarduino.github.io/tag/pca/" class="tag-cloud-link tag-link-21 tag-link-position-8" style="font-size: 8pt;" aria-label="pca (1 item)">pca</a> <a href="https://eloquentarduino.github.io/tag/rvm/" class="tag-cloud-link tag-link-13 tag-link-position-9" style="font-size: 8pt;" aria-label="rvm (1 item)">rvm</a> <a href="https://eloquentarduino.github.io/tag/svm/" class="tag-cloud-link tag-link-14 tag-link-position-10" style="font-size: 18.111111111111pt;" aria-label="svm (11 items)">svm</a> <a href="https://eloquentarduino.github.io/tag/tinyml/" class="tag-cloud-link tag-link-20 tag-link-position-11" style="font-size: 8pt;" aria-label="tinyml (1 item)">tinyml</a></div></div><div class="clear"></div></div></div></div><div class="content"><div class="posts"><div id="post-820" class="post-820 post type-post status-publish format-standard hentry category-arduino-machine-learning category-computer-vision tag-camera tag-esp32 tag-microml tag-svm"><div class="post-inner"><div class="post-header"><h1 class="post-title"><a href="https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/" rel="bookmark" title="Apple or Orange? Image recognition with ESP32 and Arduino">Apple or Orange? Image recognition with ESP32 and Arduino</a></h1><div class="post-meta"> <span class="post-date"><a href="https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/" title="Apple or Orange? Image recognition with ESP32 and Arduino">12 January 2020</a></span> <span class="date-sep"> / </span> <span class="post-author"><a href="https://eloquentarduino.github.io/author/simone/" title="Posts by simone" rel="author">simone</a></span></div></div><div class="post-content"><div class="has-content-area" data-url="https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/" data-title="Apple or Orange? Image recognition with ESP32 and Arduino"><p>Do you have an ESP32 camera?</p><p>Want to do image recognition directly on your ESP32, without a PC?</p><p>In this post we'll look into a very basic image recognition task: <strong>distinguish apples from oranges with machine learning</strong>.</p><p><noscript><img src="/wp-content/uploads/2020/01/Apple-vs-Orange.gif" alt="Apple vs Orange"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2020/01/Apple-vs-Orange.gif" alt="Apple vs Orange"></p><p><span id="more-820"></span></p><p>Image recognition is a very hot topic these days in the AI/ML landscape. <a href="https://en.wikipedia.org/wiki/Convolutional_neural_network">Convolutional Neural Networks</a> really shines in this task and can achieve almost perfect accuracy on many scenarios.</p><p>Sadly, you can't run CNN on your ESP32, they're just too large for a microcontroller.</p><p>Since in this series about <a href="/category/programming/arduino-machine-learning/">Machine Learning on Microcontrollers</a> we're exploring the potential of Support Vector Machines (SVMs) at solving different classification tasks, we'll take a look into image classification too.</p><p></p><div class="toc"><h6>Table of contents</h6><ol><li><a href="#tocwhat-were-going-to-do">What we're going to do</a></li><li><a href="#tocfeatures-definition">Features definition</a></li><li><a href="#tocextracting-rgb-components">Extracting RGB components</a></li><li><a href="#tocrecord-samples-image">Record samples image</a></li><li><a href="#toctraining-the-classifier">Training the classifier</a></li><li><a href="#tocreal-world-example">Real world example</a><ol><li><a href="#tocdisclaimer">Disclaimer</a></li></ol></li></ol></div><h2 id="tocwhat-were-going-to-do">What we're going to do</h2><p>In a previous post about <a href="/2019/12/color-identification-on-arduino/">color identification with Machine learning</a>, we used an Arduino to detect the object we were pointing at with a color sensor (TCS3200) by its color: if we detected yellow, for example, we knew we had a banana in front of us.</p><p>Of course such a process is not object recognition at all: yellow may be a banane, or a lemon, or an apple.</p><p>Object inference, in that case, works only if you have exactly one object for a given color.</p><p>The objective of this post, instead, is to investigate if we can use the MicroML framework to do simple image recognition on the images from an ESP32 camera.</p><p>This is much more similar to the tasks you do on your PC with CNN or any other form of NN you are comfortable with. Sure, we will still apply some restrictions to fit the problem on a microcontroller, but this is a huge step forward compared to the simple color identification.</p><div class="watchout"> In this context, image recognition means deciding which class (from the trained ones) the current image belongs to. <b>This algorithm can't locate interesting objects in the image, neither detect if an object is present in the frame</b>. It will classify the current image based on the samples recorded during training.</div><p>As any beginning machine learning project about image classification worth of respect, our task will be to distinguish an orange from an apple.</p><h2 id="tocfeatures-definition">Features definition</h2><p>I have to admit that I rarely use NN, so I may be wrong here, but from the examples I read online it looks to me that features engineering is not a fundamental task with NN.</p><p>Those few times I used CNN, I always used the whole image as input, <em>as-is</em>. I didn't extracted any feature from them (e.g. color histogram): the CNN worked perfectly fine with raw images.</p><p>I don't think this will work best with SVM, but in this first post we're starting as simple as possible, so we'll be using the RGB components of the image as our features. In a future post, we'll introduce additional features to try to improve our results.</p><p>I said we're using the RGB components of the image. But not all of them.</p><p>Even at the lowest resolution of 160x120 pixels, a raw RGB image from the camera would generate 160x120x3 = 57600 features: way too much.</p><p>We need to reduce this number  to the bare minimum.</p><p>How much pixels do you think are necessary to get reasonable results in this task of classifying apples from oranges?</p><p>You would be surprised to know that I got 90% accuracy with an RGB image of <strong>8x6</strong>!</p><p><noscript><img src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/Orange-and-Apple-pixelated.jpg" alt="You actually need very few pixels to do image classification"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/Orange-and-Apple-pixelated.jpg" alt="You actually need very few pixels to do image classification"></p><p>Yes, that's all we really need to do a <em>good enough</em> classification.</p> <span class="bctt-click-to-tweet"><span class="bctt-ctt-text"><a href="https://twitter.com/intent/tweet?url=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fimage-recognition-with-esp32-and-arduino%2F&text=You%20can%20distinguish%20apples%20from%20oranges%20on%20ESP32%20with%208x6%20pixels%20only%21&via=EloquentArduino&related=EloquentArduino" target="_blank" rel="noopener noreferrer">You can distinguish apples from oranges on ESP32 with 8x6 pixels only! </a></span><a href="https://twitter.com/intent/tweet?url=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fimage-recognition-with-esp32-and-arduino%2F&text=You%20can%20distinguish%20apples%20from%20oranges%20on%20ESP32%20with%208x6%20pixels%20only%21&via=EloquentArduino&related=EloquentArduino" target="_blank" class="bctt-ctt-btn" rel="noopener noreferrer">Click To Tweet</a></span><p>Of course this is a tradeoff: you can't expect to achieve 99% accuracy while mantaining the model size small enough to fit on a microcontroller. 90% is an acceptable accuracy for me in this context.</p><p>You have to keep in mind, moreover, that the features vector size grows quadratically with the image size (if you keep the aspect ratio). A raw RGB image of 8x6 generates 144 features: an image of 16x12 generates 576 features. This was already causing random crashes on my ESP32.</p><p>So we'll stick to 8x6 images.</p><p>Now, how do you compact a 160x120 image to 8x6? With <em>downsampling</em>.</p><p>This is the same tecnique we've used in the post about <a href="/2020/01/motion-detection-with-esp32-cam-only-arduino-version/">motion detection on ESP32</a>: we define a block size and average all the pixels inside the block to get a single value (you can refer to that post for more details).</p><p><noscript><img src="/wp-content/uploads/2020/01/Image-downsampling-example.jpg" alt="Image downsampling example"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2020/01/Image-downsampling-example.jpg" alt="Image downsampling example"></p><p>This time, though, we're working with RGB images instead of grayscale, so we'll repeat the exact same process 3 times, one for each channel.</p><p>This is the code excerpt that does the downsampling.</p><pre><code class="language-cpp">uint16_t rgb_frame[HEIGHT / BLOCK_SIZE][WIDTH / BLOCK_SIZE][3] = { 0 };

void grab_image() {
    for (size_t i = 0; i < len; i += 2) {
        // get r, g, b from the buffer
        // see later

        const size_t j = i / 2;
        // transform x, y in the original image to x, y in the downsampled image
        // by dividing by BLOCK_SIZE
        const uint16_t x = j % WIDTH;
        const uint16_t y = floor(j / WIDTH);
        const uint8_t block_x = floor(x / BLOCK_SIZE);
        const uint8_t block_y = floor(y / BLOCK_SIZE);

        // average pixels in block (accumulate)
        rgb_frame[block_y][block_x][0] += r;
        rgb_frame[block_y][block_x][1] += g;
        rgb_frame[block_y][block_x][2] += b;
    }
}</code></pre><div id="mc_embed_signup"><form action="https://github.us4.list-manage.com/subscribe/post?u=f0eaedd94d554cf2ee781742a&id=37d3496031" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate><div id="mc_embed_signup_scroll"><h2 style="margin: 0; text-align: center">Finding this content useful?</h2><div class="mc-field-group"> <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="join the monthly newsletter"></div><div id="mce-responses" class="clear"><div class="response" id="mce-error-response" style="display:none"></div><div class="response" id="mce-success-response" style="display:none"></div></div><div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_f0eaedd94d554cf2ee781742a_37d3496031" tabindex="-1" value=""></div><div class="clear" style="position: relative; top: 8px"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div></div></form></div><h2 id="tocextracting-rgb-components">Extracting RGB components</h2><p>The ESP32 camera can store the image in different formats (of our interest — there are a couple more available):</p><ol><li><strong>grayscale</strong>: no color information, just the intensity is stored. The buffer has size HEIGHT*WIDTH</li><li><strong>RGB565</strong>: stores each RGB pixel in two bytes, with 5 bit for red, 6 for green and 5 for blue. The buffer has size HEIGHT * WIDTH * 2</li><li><strong>JPEG</strong>: encodes (in hardware?) the image to jpeg. The buffer has a variable length, based on the encoding results</li></ol><p>For our purpose, we'll use the RGB565 format and extract the 3 components from the 2 bytes with the following code.</p><p><noscript><img src="https://s2.www.theimagingsource.com/application-1.1.29/documentation/ic_imaging_control_class/en_US/images/rgb565.gif" alt="taken from https://www.theimagingsource.com/support/documentation/ic-imaging-control-cpp/PixelformatRGB565.htm"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="https://s2.www.theimagingsource.com/application-1.1.29/documentation/ic_imaging_control_class/en_US/images/rgb565.gif" alt="taken from https://www.theimagingsource.com/support/documentation/ic-imaging-control-cpp/PixelformatRGB565.htm"></p><pre><code class="language-cpp">config.pixel_format = PIXFORMAT_RGB565;

for (size_t i = 0; i < len; i += 2) {
    const uint8_t high = buf[i];
    const uint8_t low  = buf[i+1];
    const uint16_t pixel = (high << 8) | low;

    const uint8_t r = (pixel & 0b1111100000000000) >> 11;
    const uint8_t g = (pixel & 0b0000011111100000) >> 6;
    const uint8_t b = (pixel & 0b0000000000011111);
}</code></pre><h2 id="tocrecord-samples-image">Record samples image</h2><p>Now that we can grab the images from the camera, we'll need to take a few samples of each object we want to racognize.</p><p>Before doing so, we'll linearize the image matrix to a 1-dimensional vector, because that's what our prediction function expects.</p><pre><code class="language-cpp">#define H (HEIGHT / BLOCK_SIZE)
#define W (WIDTH / BLOCK_SIZE)

void linearize_features() {
  size_t i = 0;
  double features[H*W*3] = {0};

  for (int y = 0; y < H; y++) {
    for (int x = 0; x < W; x++) {
      features[i++] = rgb_frame[y][x][0];
      features[i++] = rgb_frame[y][x][1];
      features[i++] = rgb_frame[y][x][2];
    }
  }

  // print to serial
  for (size_t i = 0; i < H*W*3; i++) {
    Serial.print(features[i]);
    Serial.print('\t');
  }

  Serial.println();
}</code></pre><p>Now you can setup your acquisition environment and take the samples: 15-20 of each object will do the job.</p><div class="watchout"> Image acquisition is a very noisy process: even keeping the camera still, you will get fluctuating values. <br>You need to be very accurate during this phase if you want to achieve good results.<br> I suggest you immobilize your camera with tape to a flat surface or use some kind of photographic easel.</div><h2 id="toctraining-the-classifier">Training the classifier</h2><p>To train the classifier, save the features for each object in a file, one features vector per line. Then follow the steps on <a href="/2019/11/how-to-train-a-classifier-in-scikit-learn">how to train a ML classifier for Arduino</a> to get the exported model.</p><p>You can experiment with different classifier configurations.</p><p>My features were well distinguishable, so I had great results (100% accuracy) with any kernel (even linear).</p><p>One odd thing happened with the RBF kernel: I had to use an extremely low gamma value (0.0000001). Does anyone can explain me why? I usually go with a default value of 0.001.</p><p>The model produced 13 support vectors.</p><p>I did no features scaling: you could try it if classifying more than 2 classes and having poor results.</p><p><noscript><img src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/Apple-vs-Orange-decision-boundaries.png" alt="Apple vs Orange decision boundaries"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/Apple-vs-Orange-decision-boundaries.png" alt="Apple vs Orange decision boundaries"></p><h2 id="tocreal-world-example">Real world example</h2><p>If you followed all the steps above, you should now have a model capable of detecting if your camera is shotting an apple or an orange, as you can see in the following video.</p><div style="width: 788px;" class="wp-video"><video class="wp-video-shortcode" id="video-820-1" width="788" height="443" preload="metadata" controls="controls"><source type="video/mp4" src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/Apple-vs-Orange.mp4?_=1"></source><a href="https://eloquentarduino.github.io/wp-content/uploads/2020/01/Apple-vs-Orange.mp4">https://eloquentarduino.github.io/wp-content/uploads/2020/01/Apple-vs-Orange.mp4</a></video></div><p></p><p>The little white object you see at the bottom of the image is the camera, taped to the desk.</p><p>Did you think it was possible to do simple image classification on your ESP32?</p><h3 id="tocdisclaimer">Disclaimer</h3><p>This is not full-fledged object recognition: it can't label objects while you walk as Tensorflow can do, for example.</p><p>You have to carefully craft your setup and be as consistent as possible between training and inferencing.</p><p>Still, I think this is a fun proof-of-concept that can have useful applications in simple scenarios where you can live with a fixed camera and don't want to use a full Raspberry Pi.</p><p>In the next weeks I settled to finally try TensorFlow Lite for Microcontrollers on my ESP32, so I'll try to do a comparison between them and this example and report my results.</p><p>Now that you can do image classification on your ESP32, can you think of a use case you will be able to apply this code to?</p><p>Let me know in the comments, we could even try realize it together if you need some help.</p><hr><p>Check the full project code on <a href="https://github.com/eloquentarduino/EloquentArduino/blob/master/examples/Apple_vs_Orange/Apple_vs_Orange.ino" target="_blank" rel="noopener noreferrer">Github</a></p></div><div class="heateorSssClear"></div><div class="heateor_sss_sharing_container heateor_sss_horizontal_sharing" heateor-sss-data-href="https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/"><div class="heateor_sss_sharing_title" style="font-weight:bold">Help the blow grow</div><ul class="heateor_sss_sharing_ul"><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" alt="Facebook" title="Facebook" class="heateorSssSharing heateorSssFacebookBackground" onclick='heateorSssPopup("https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fimage-recognition-with-esp32-and-arduino%2F")'><ss style="display:block;border-radius:999px;" class="heateorSssSharingSvg heateorSssFacebookSvg"></ss></i></li><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" alt="Twitter" title="Twitter" class="heateorSssSharing heateorSssTwitterBackground" onclick='heateorSssPopup("http://twitter.com/intent/tweet?via=ArduinoEloquent&text=Apple%20or%20Orange%3F%20Image%20recognition%20with%20ESP32%20and%20Arduino&url=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fimage-recognition-with-esp32-and-arduino%2F")'><ss style="display:block;border-radius:999px;" class="heateorSssSharingSvg heateorSssTwitterSvg"></ss></i></li><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" alt="Linkedin" title="Linkedin" class="heateorSssSharing heateorSssLinkedinBackground" onclick='heateorSssPopup("http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fimage-recognition-with-esp32-and-arduino%2F&title=Apple%20or%20Orange%3F%20Image%20recognition%20with%20ESP32%20and%20Arduino")'><ss style="display:block;border-radius:999px;" class="heateorSssSharingSvg heateorSssLinkedinSvg"></ss></i></li><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" title="More" alt="More" class="heateorSssSharing heateorSssMoreBackground" onclick="heateorSssMoreSharingPopup(this, 'https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/', 'Apple%20or%20Orange%3F%20Image%20recognition%20with%20ESP32%20and%20Arduino', '' )"><ss style="display:block" class="heateorSssSharingSvg heateorSssMoreSvg"></ss></i></li></ul><div class="heateorSssClear"></div></div><div class="heateorSssClear"></div><div class="heateor_sss_sharing_container heateor_sss_vertical_sharing heateor_sss_bottom_sharing" style="width:44px;right: -10px;top: 100px;-webkit-box-shadow:none;box-shadow:none;" heateor-sss-data-href="https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/"><ul class="heateor_sss_sharing_ul"><li class=""><i style="width:40px;height:40px;margin:0;" alt="Facebook" title="Facebook" class="heateorSssSharing heateorSssFacebookBackground" onclick='heateorSssPopup("https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fimage-recognition-with-esp32-and-arduino%2F")'><ss style="display:block;" class="heateorSssSharingSvg heateorSssFacebookSvg"></ss></i></li><li class=""><i style="width:40px;height:40px;margin:0;" alt="Twitter" title="Twitter" class="heateorSssSharing heateorSssTwitterBackground" onclick='heateorSssPopup("http://twitter.com/intent/tweet?via=ArduinoEloquent&text=Apple%20or%20Orange%3F%20Image%20recognition%20with%20ESP32%20and%20Arduino&url=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fimage-recognition-with-esp32-and-arduino%2F")'><ss style="display:block;" class="heateorSssSharingSvg heateorSssTwitterSvg"></ss></i></li><li class=""><i style="width:40px;height:40px;margin:0;" title="More" alt="More" class="heateorSssSharing heateorSssMoreBackground" onclick="heateorSssMoreSharingPopup(this, 'https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/', 'Apple%20or%20Orange%3F%20Image%20recognition%20with%20ESP32%20and%20Arduino', '' )"><ss style="display:block" class="heateorSssSharingSvg heateorSssMoreSvg"></ss></i></li></ul><div class="heateorSssClear"></div></div><div class="crp_related  "><h3>Related Posts</h3><ul><li><a href="https://eloquentarduino.github.io/2020/08/better-word-classification-with-arduino-33-ble-sense-and-machine-learning/" class="post-1282"><span class="crp_title">Better word classification with Arduino Nano 33 BLE Sense and Machine Learning</span></a></li><li><a href="https://eloquentarduino.github.io/2020/06/arduino-dimensionality-reduction-pca-for-machine-learning-projects/" class="post-1174"><span class="crp_title">Arduino dimensionality reduction (PCA) for Machine Learning projects</span></a></li><li><a href="https://eloquentarduino.github.io/2020/10/decision-tree-random-forest-and-xgboost-on-arduino/" class="post-1264"><span class="crp_title">Decision Tree, Random Forest and XGBoost on Arduino</span></a></li><li><a href="https://eloquentarduino.github.io/2020/05/anomaly-detection-on-your-arduino-microcontroller-via-one-class-svm/" class="post-1156"><span class="crp_title">Anomaly detection on your Arduino microcontroller via One Class SVM</span></a></li></ul><div class="crp_clear"></div></div><div id="disqus_thread"></div></div><div class="clear"></div></div></div></div><div class="post-meta-bottom"><div class="post-cat-tags"><p class="post-categories"><span>Categories:</span> <a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/" rel="category tag">Arduino Machine learning</a>, <a href="https://eloquentarduino.github.io/category/programming/computer-vision/" rel="category tag">Computer vision</a></p><p class="post-tags">Tags: <a href="https://eloquentarduino.github.io/tag/camera/" rel="tag">camera</a>, <a href="https://eloquentarduino.github.io/tag/esp32/" rel="tag">esp32</a>, <a href="https://eloquentarduino.github.io/tag/microml/" rel="tag">microml</a>, <a href="https://eloquentarduino.github.io/tag/svm/" rel="tag">svm</a></p></div><div class="archive-nav post-nav"> <a class="post-nav-older" title="Previous post: Motion detection with ESP32 cam only (Arduino version)" href="https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/"> « Motion detection with ESP32 cam only (Arduino version) </a> <a class="post-nav-newer" title="Next post: Easy Tensorflow TinyML on ESP32 and Arduino" href="https://eloquentarduino.github.io/2020/01/easy-tinyml-on-esp32-and-arduino/"> Easy Tensorflow TinyML on ESP32 and Arduino » </a><div class="clear"></div></div></div><p class="nocomments">Comments are closed.</p><div class="footer section large-padding bg-dark"><div class="clear"></div></div><div class="credits"><div class="credits-inner"><p class="credits-left">© 2020 <a href="https://eloquentarduino.github.io" title="Eloquent Arduino Blog">Eloquent Arduino Blog</a></p><p class="credits-right"><span>Theme by <a href="https://www.andersnoren.se">Anders Norén</a></span> — <a title="To the top" class="tothetop">Up ↑</a></p><div class="clear"></div></div></div></div><div class="clear"></div></div> <script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script> <script src="//cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-154550080-1"></script> <script>if (window.location.href.indexOf("eloquent.blog") < 0) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154550080-1');
}</script>  <script>(function() {
setTimeout(function() {
  var d = document, s = d.createElement('script');
  s.src = 'https://eloquent-arduino.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);},
10000);
})();</script>  <noscript><style>.lazyload{display:none;}</style></noscript><script data-noptimize="1">window.lazySizesConfig=window.lazySizesConfig||{};window.lazySizesConfig.loadMode=1;</script><script async data-noptimize="1" src="https://eloquentarduino.github.io/wp-content/plugins/autoptimize/classes/external/js/lazysizes.min.js"></script> <link rel="stylesheet" id="fontawesome5-css" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" type="text/css" media="all"> <script type="text/javascript">function heateorSssLoadEvent(e) {var t=window.onload;if (typeof window.onload!="function") {window.onload=e}else{window.onload=function() {t();e()}}};	var heateorSssSharingAjaxUrl = 'https://eloquentarduino.github.io/wp-admin/admin-ajax.php', heateorSssCloseIconPath = 'https://eloquentarduino.github.io/wp-content/plugins/sassy-social-share/public/../images/close.png', heateorSssPluginIconPath = 'https://eloquentarduino.github.io/wp-content/plugins/sassy-social-share/public/../images/logo.png', heateorSssHorizontalSharingCountEnable = 0, heateorSssVerticalSharingCountEnable = 0, heateorSssSharingOffset = -10; var heateorSssMobileStickySharingEnabled = 1;var heateorSssCopyLinkMessage = "Link copied.";var heateorSssUrlCountFetched = [], heateorSssSharesText = 'Shares', heateorSssShareText = 'Share';function heateorSssPopup(e) {window.open(e,"popUpWindow","height=400,width=600,left=400,top=100,resizable,scrollbars,toolbar=0,personalbar=0,menubar=no,location=no,directories=no,status")};var heateorSssWhatsappShareAPI = "web";</script> <script type="text/javascript" src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill.min.js"></script> <script type="text/javascript">( 'fetch' in window ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-fetch.min.js?ver=3.0.0">' + 'ipt>' );( document.contains ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-node-contains.min.js?ver=3.26.0-0">' + 'ipt>' );( window.FormData && window.FormData.prototype.keys ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-formdata.min.js?ver=3.0.12">' + 'ipt>' );( Element.prototype.matches && Element.prototype.closest ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-element-closest.min.js?ver=2.0.2">' + 'ipt>' );</script> <script type="text/javascript" src="https://eloquentarduino.github.io/wp-includes/js/dist/i18n.min.js"></script> <script type="text/javascript">var highlight_and_share = {"show_facebook":"1","show_twitter":"1","show_linkedin":"1","show_pinterest":"","show_email":"","show_xing":"","show_copy":"","show_whatsapp":"","twitter_username":"EloquentArduino","twitter_fa_class":"fa fa-twitter","facebook_fa_class":"fa fa-facebook","linkedin_fa_class":"fa fa-linkedin","pinterest_fa_class":"fa fa-pinterest","xing_fa_class":"fa fa-xing","whatsapp_fa_class":"fa fa-whatsapp","copy_fa_class":"fa fa-copy","email_fa_class":"fa fa-envelope","mobile":"","content":".has-content-area","tweet_text":"Tweet","facebook_text":"Share","linkedin_text":"LinkedIn","pinterest_text":"Pinterest","whatsapp_text":"WhatsApp","xing_text":"Xing","copy_text":"Copy","email_text":"E-mail","icons":"1","facebook_app_id":"2530754057166153","email_your_name_value":"","email_from_value":"","nonce":"591148a922","ajax_url":"https:\/\/eloquentarduino.github.io\/wp-admin\/admin-ajax.php","email_share":"Share This Post Via Email","email_subject":"Your Subject","email_your_name":"Your Name","email_send_email":"Send to Email Address","email_subject_text":"[Shared Post] %title%","email_from":"Your Email Address","email_send":"Send Email","email_cancel":"Cancel","email_close":"Close","email_loading":"https:\/\/eloquentarduino.github.io\/wp-content\/plugins\/highlight-and-share\/img\/loading.gif","email_subject_error":"You must fill in a subject.","email_email_to":"Send to Email Address is blank.","email_email_from":"Your email address is blank.","email_email_name":"Your name is blank.","email_sending":"Sending...","customizer_preview":""};</script> <script type="text/javascript">( function( domain, translations ) {
	var localeData = translations.locale_data[ domain ] || translations.locale_data.messages;
	localeData[""].domain = domain;
	wp.i18n.setLocaleData( localeData, domain );
} )( "highlight-and-share", { "locale_data": { "messages": { "": {} } } } );</script> <script type="text/javascript">var mejsL10n = {"language":"en","strings":{"mejs.install-flash":"You are using a browser that does not have Flash player enabled or installed. Please turn on your Flash player plugin or download the latest version from https:\/\/get.adobe.com\/flashplayer\/","mejs.fullscreen-off":"Turn off Fullscreen","mejs.fullscreen-on":"Go Fullscreen","mejs.download-video":"Download Video","mejs.fullscreen":"Fullscreen","mejs.time-jump-forward":["Jump forward 1 second","Jump forward %1 seconds"],"mejs.loop":"Toggle Loop","mejs.play":"Play","mejs.pause":"Pause","mejs.close":"Close","mejs.time-slider":"Time Slider","mejs.time-help-text":"Use Left\/Right Arrow keys to advance one second, Up\/Down arrows to advance ten seconds.","mejs.time-skip-back":["Skip back 1 second","Skip back %1 seconds"],"mejs.captions-subtitles":"Captions\/Subtitles","mejs.captions-chapters":"Chapters","mejs.none":"None","mejs.mute-toggle":"Mute Toggle","mejs.volume-help-text":"Use Up\/Down Arrow keys to increase or decrease volume.","mejs.unmute":"Unmute","mejs.mute":"Mute","mejs.volume-slider":"Volume Slider","mejs.video-player":"Video Player","mejs.audio-player":"Audio Player","mejs.ad-skip":"Skip ad","mejs.ad-skip-info":["Skip in 1 second","Skip in %1 seconds"],"mejs.source-chooser":"Source Chooser","mejs.stop":"Stop","mejs.speed-rate":"Speed Rate","mejs.live-broadcast":"Live Broadcast","mejs.afrikaans":"Afrikaans","mejs.albanian":"Albanian","mejs.arabic":"Arabic","mejs.belarusian":"Belarusian","mejs.bulgarian":"Bulgarian","mejs.catalan":"Catalan","mejs.chinese":"Chinese","mejs.chinese-simplified":"Chinese (Simplified)","mejs.chinese-traditional":"Chinese (Traditional)","mejs.croatian":"Croatian","mejs.czech":"Czech","mejs.danish":"Danish","mejs.dutch":"Dutch","mejs.english":"English","mejs.estonian":"Estonian","mejs.filipino":"Filipino","mejs.finnish":"Finnish","mejs.french":"French","mejs.galician":"Galician","mejs.german":"German","mejs.greek":"Greek","mejs.haitian-creole":"Haitian Creole","mejs.hebrew":"Hebrew","mejs.hindi":"Hindi","mejs.hungarian":"Hungarian","mejs.icelandic":"Icelandic","mejs.indonesian":"Indonesian","mejs.irish":"Irish","mejs.italian":"Italian","mejs.japanese":"Japanese","mejs.korean":"Korean","mejs.latvian":"Latvian","mejs.lithuanian":"Lithuanian","mejs.macedonian":"Macedonian","mejs.malay":"Malay","mejs.maltese":"Maltese","mejs.norwegian":"Norwegian","mejs.persian":"Persian","mejs.polish":"Polish","mejs.portuguese":"Portuguese","mejs.romanian":"Romanian","mejs.russian":"Russian","mejs.serbian":"Serbian","mejs.slovak":"Slovak","mejs.slovenian":"Slovenian","mejs.spanish":"Spanish","mejs.swahili":"Swahili","mejs.swedish":"Swedish","mejs.tagalog":"Tagalog","mejs.thai":"Thai","mejs.turkish":"Turkish","mejs.ukrainian":"Ukrainian","mejs.vietnamese":"Vietnamese","mejs.welsh":"Welsh","mejs.yiddish":"Yiddish"}};</script> <script type="text/javascript">var _wpmejsSettings = {"pluginPath":"\/wp-includes\/js\/mediaelement\/","classPrefix":"mejs-","stretching":"responsive"};</script> <script defer src="https://eloquentarduino.github.io/wp-content/cache/autoptimize/js/autoptimize_c57c718ee0746b3c35bdddf3f4dc5525.js"></script></body></html>
