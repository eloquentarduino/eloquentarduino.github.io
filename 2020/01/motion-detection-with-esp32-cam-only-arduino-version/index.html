<!DOCTYPE html>
<html lang="en-US"><head profile="http://gmpg.org/xfn/11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" id="ao_optimized_gfonts" href="https://fonts.googleapis.com/css?family=Lato%3A400%2C700%2C400italic%2C700italic%7CLato:400,700&display=swap"><link media="all" href="https://eloquentarduino.github.io/wp-content/cache/autoptimize/css/autoptimize_3adcc4aa0f508f63de69328b1247abf3.css" rel="stylesheet"><title>Motion detection with ESP32 cam only (Arduino version)</title><meta name="description" content="-1325"><meta name="robots" content="index, follow"><meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Motion detection with ESP32 cam only (Arduino version)"><meta property="og:description" content="-1325"><meta property="og:url" content="https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/"><meta property="og:site_name" content="Eloquent Arduino Blog"><meta property="article:published_time" content="2020-01-05T11:08:08+00:00"><meta property="article:modified_time" content="2020-03-08T10:43:11+00:00"><meta property="og:image" content="https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-motion-detection-example.gif"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Motion detection with ESP32 camera only (Arduino version)"><meta name="twitter:description" content="ESP32 pure video motion detection with @M5Stack camera and Arduino IDE. No PIR required! #arduino #esp32 #ComputerVision"><meta name="twitter:image" content="https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-motion-detection-example.gif"> <script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://eloquentarduino.github.io/#website","url":"https://eloquentarduino.github.io/","name":"Eloquent Arduino Blog","description":"Machine learning on Arduino, programming & electronics","publisher":{"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901"},"potentialAction":[{"@type":"SearchAction","target":"https://eloquentarduino.github.io/?s={search_term_string}","query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/#primaryimage","inLanguage":"en-US","url":"https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-motion-detection-example.gif","width":600,"height":556,"caption":"ESP32 camera motion detection example"},{"@type":"WebPage","@id":"https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/#webpage","url":"https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/","name":"Motion detection with ESP32 cam only (Arduino version)","isPartOf":{"@id":"https://eloquentarduino.github.io/#website"},"primaryImageOfPage":{"@id":"https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/#primaryimage"},"datePublished":"2020-01-05T11:08:08+00:00","dateModified":"2020-03-08T10:43:11+00:00","description":"-1325","inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/"]}]},{"@type":"Article","@id":"https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/#article","isPartOf":{"@id":"https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/#webpage"},"author":{"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901"},"headline":"Motion detection with ESP32 cam only (Arduino version)","datePublished":"2020-01-05T11:08:08+00:00","dateModified":"2020-03-08T10:43:11+00:00","commentCount":0,"mainEntityOfPage":{"@id":"https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/#webpage"},"publisher":{"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901"},"image":{"@id":"https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/#primaryimage"},"keywords":"camera,esp32","articleSection":"Computer vision","inLanguage":"en-US"},{"@type":["Person","Organization"],"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901","name":"simone","image":{"@type":"ImageObject","@id":"https://eloquentarduino.github.io/#personlogo","inLanguage":"en-US","url":"https://eloquentarduino.github.io/wp-content/uploads/2019/12/avatar.jpg","width":330,"height":330,"caption":"simone"},"logo":{"@id":"https://eloquentarduino.github.io/#personlogo"}}]}</script> <link rel="dns-prefetch" href="//use.fontawesome.com"><link rel="dns-prefetch" href="//s.w.org"><link href="https://fonts.gstatic.com" crossorigin="anonymous" rel="preconnect"><link rel="stylesheet" id="font-awesome-official-css" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css" type="text/css" media="all" integrity="sha384-REHJTs1r2ErKBuJB0fCK99gCYsVjwxHrSU0N7I1zl9vZbggVJXRMsv/sLlOAGb4M" crossorigin="anonymous"><link rel="stylesheet" id="font-awesome-official-v4shim-css" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css" type="text/css" media="all" integrity="sha384-AL44/7DEVqkvY9j8IjGLGZgFmHAjuHa+2RIWKxDliMNIfSs9g14/BRpYwHrWQgz6" crossorigin="anonymous"> <script type="text/javascript" src="https://eloquentarduino.github.io/wp-includes/js/jquery/jquery.js"></script> <meta name="google-site-verification" content="xgigjPrbbYDemskTaGLT9WGhmw8wgdeFtpDxVak0awI"></head><body class="post-template-default single single-post postid-779 single-format-standard"><div class="wrapper"><div class="sidebar"><div class="blog-header"> <a class="blog-logo" href="https://eloquentarduino.github.io" title="Eloquent Arduino Blog â€” Machine learning on Arduino, programming & electronics" rel="home"> <noscript><img src="https://eloquentarduino.github.io/wp-content/uploads/2019/12/logo-completo.png" alt="Eloquent Arduino Blog"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20%20%22%3E%3C/svg%3E" data-src="https://eloquentarduino.github.io/wp-content/uploads/2019/12/logo-completo.png" alt="Eloquent Arduino Blog"> </a></div><div class="nav-toggle toggle"><p> <span class="show">Show menu</span> <span class="hide">Hide menu</span></p><div class="bars"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="clear"></div></div></div><div class="blog-menu"><ul class="navigation"><li id="menu-item-461" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-461"><a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/">Arduino Machine learning</a></li><li id="menu-item-462" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-462"><a href="https://eloquentarduino.github.io/category/programming/eloquent-library/">Eloquent library</a></li></ul><div class="clear"></div></div><div class="mobile-menu"><ul class="navigation"><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-461"><a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/">Arduino Machine learning</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-462"><a href="https://eloquentarduino.github.io/category/programming/eloquent-library/">Eloquent library</a></li></ul></div><div class="widgets" role="complementary"><div class="widget_text widget widget_custom_html"><div class="widget_text widget-content"><div class="textwidget custom-html-widget"><div style="text-align: center"> <noscript><img src="/wp-content/uploads/2020/04/profilo.png" alt="Profile pic" style="width: 125px"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20%20%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2020/04/profilo.png" alt="Profile pic" style="width: 125px"> <a href="/about-me" style="display: block; font-size: 18px">About me</a></div></div></div><div class="clear"></div></div><div class="widget widget_search"><div class="widget-content"><form method="get" class="searchform" action="https://eloquentarduino.github.io" id="searchform"><div role="search" class="searchbox__wrapper"> <input id="search-input" type="search" name="search" placeholder="Search the blog" autocomplete="off" required="required" class="searchbox__input"> <button type="submit" title="Submit your search query." class="searchbox__submit"> <svg role="img" aria-label="Search"> <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#sbx-icon-search-13"></use> </svg> </button> <button type="reset" title="Clear the search query." class="searchbox__reset hide"> <svg role="img" aria-label="Reset"> <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#sbx-icon-clear-3"></use> </svg> </button></div></form></div><div class="clear"></div></div><div class="widget widget_recent_entries"><div class="widget-content"><h3 class="widget-title">Recent Posts</h3><ul><li> <a href="https://eloquentarduino.github.io/2020/04/incremental-multiclass-classification-on-microcontrollers-one-vs-one/">Incremental multiclass classification on microcontrollers: One vs One</a></li><li> <a href="https://eloquentarduino.github.io/2020/04/stochastic-gradient-descent-on-your-microcontroller/">Stochastic Gradient Descent on your microcontroller</a></li><li> <a href="https://eloquentarduino.github.io/2020/04/passive-aggressive-classifier-for-embedded-devices/">Passive-aggressive classifier for embedded devices</a></li><li> <a href="https://eloquentarduino.github.io/2020/03/how-to-train-a-color-classification-machine-learning-classifier-directly-on-your-arduino-board/">How to train a color classification Machine learning classifier directly on your Arduino board</a></li><li> <a href="https://eloquentarduino.github.io/2020/03/how-to-train-a-iris-classification-machine-learning-classifier-directly-on-your-arduino-board/">How to train a IRIS classification Machine learning classifier directly on your Arduino board</a></li></ul></div><div class="clear"></div></div><div class="widget widget_sub_categories"><div class="widget-content"><h3 class="widget-title">Programming</h3><ul><li class="cat-item cat-item-8"><a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/">Arduino Machine learning</a></li><li class="cat-item cat-item-12"><a href="https://eloquentarduino.github.io/category/programming/computer-vision/">Computer vision</a></li><li class="cat-item cat-item-7"><a href="https://eloquentarduino.github.io/category/programming/eloquent-library/">Eloquent library</a></li></ul></div><div class="clear"></div></div><div class="widget widget_tag_cloud"><div class="widget-content"><h3 class="widget-title">TAGS</h3><div class="tagcloud"><a href="https://eloquentarduino.github.io/tag/camera/" class="tag-cloud-link tag-link-11 tag-link-position-1" style="font-size: 12.375pt;" aria-label="camera (3 items)">camera</a> <a href="https://eloquentarduino.github.io/tag/eloquent/" class="tag-cloud-link tag-link-4 tag-link-position-2" style="font-size: 12.375pt;" aria-label="eloquent (3 items)">eloquent</a> <a href="https://eloquentarduino.github.io/tag/esp32/" class="tag-cloud-link tag-link-10 tag-link-position-3" style="font-size: 12.375pt;" aria-label="esp32 (3 items)">esp32</a> <a href="https://eloquentarduino.github.io/tag/incremental-learning/" class="tag-cloud-link tag-link-16 tag-link-position-4" style="font-size: 8pt;" aria-label="incremental-learning (1 item)">incremental-learning</a> <a href="https://eloquentarduino.github.io/tag/microml/" class="tag-cloud-link tag-link-5 tag-link-position-5" style="font-size: 22pt;" aria-label="microml (17 items)">microml</a> <a href="https://eloquentarduino.github.io/tag/ml/" class="tag-cloud-link tag-link-17 tag-link-position-6" style="font-size: 8pt;" aria-label="ml (1 item)">ml</a> <a href="https://eloquentarduino.github.io/tag/online-learning/" class="tag-cloud-link tag-link-15 tag-link-position-7" style="font-size: 10.625pt;" aria-label="online-learning (2 items)">online-learning</a> <a href="https://eloquentarduino.github.io/tag/rvm/" class="tag-cloud-link tag-link-13 tag-link-position-8" style="font-size: 8pt;" aria-label="rvm (1 item)">rvm</a> <a href="https://eloquentarduino.github.io/tag/svm/" class="tag-cloud-link tag-link-14 tag-link-position-9" style="font-size: 8pt;" aria-label="svm (1 item)">svm</a></div></div><div class="clear"></div></div></div></div><div class="content"><div class="posts"><div id="post-779" class="post-779 post type-post status-publish format-standard hentry category-computer-vision tag-camera tag-esp32"><div class="post-inner"><div class="post-header"><h1 class="post-title"><a href="https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/" rel="bookmark" title="Motion detection with ESP32 cam only (Arduino version)">Motion detection with ESP32 cam only (Arduino version)</a></h1><div class="post-meta"> <span class="post-date"><a href="https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/" title="Motion detection with ESP32 cam only (Arduino version)">5 January 2020</a></span> <span class="date-sep"> / </span> <span class="post-author"><a href="https://eloquentarduino.github.io/author/simone/" title="Posts by simone" rel="author">simone</a></span></div></div><div class="post-content"><div class="has-content-area" data-url="https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/" data-title="Motion detection with ESP32 cam only (Arduino version)"><p>Do you have an <strong>ESP32 camera</strong>? Do you want to do motion detection <em>WITHOUT ANY</em> external hardware?</p><p>Here's a tutorial made just for you: <strong>30 lines of code</strong> and you will know when something changes in your video stream  ðŸŽ¥</p><p><noscript><img src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-motion-detection-example.gif" alt="ESP32 camera motion detection example"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20%20%22%3E%3C/svg%3E" data-src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-motion-detection-example.gif" alt="ESP32 camera motion detection example"></p><p><span id="more-779"></span></p><p></p><div class="toc"><h6>Table of contents</h6><ol><li><a href="#tocwhat-is-naive-motion-detection">What is (naive) motion detection?</a></li><li><a href="#toccant-i-use-an-external-pir">Can't I use an external PIR?</a><ol><li><a href="#tocexternal-hardware">External hardware</a></li><li><a href="#tocfield-of-view">Field of View</a></li><li><a href="#toccold-objects">Cold objects</a></li></ol></li><li><a href="#tocwhat-do-you-need">What do you need?</a></li><li><a href="#tochow-does-it-work">How does it work?</a><ol><li><a href="#tocdownsampling">Downsampling</a></li><li><a href="#tocblocks-difference-threshold">Blocks difference threshold</a></li><li><a href="#tocimage-difference-threshold">Image difference threshold</a></li><li><a href="#toccombining-all-together">Combining all together</a></li></ol></li><li><a href="#tocreal-world-example">Real world example</a></li></ol></div><h2 id="tocwhat-is-naive-motion-detection">What is (naive) motion detection?</h2><p>Quoting from Wikipedia</p><blockquote><p>Motion detection is the process of detecting a change in the position of an object relative to its surroundings or a change in the surroundings relative to an object</p></blockquote><p>In this project, we're implementing what I call <em>naive</em> motion detection: that is, we're not focusing on a particular object and following its motion.</p><p>We'll only detect if any considerable portion of the image changed from one frame to the next.</p><p>We won't identify the location of motion (that's the subject for a next project), neither what caused it. We will analyze video stream in (almost) real-time and compare frame by frame: if lots of pixels changed, we'll call it motion.</p><h2 id="toccant-i-use-an-external-pir">Can't I use an external PIR?</h2><p>Several projects on the internet about motion detection with an ESP32 cam use an external <a href="https://en.wikipedia.org/wiki/Passive_infrared_sensor">PIR sensor</a> to trigger the video recording.</p><p>What's the problem with that approach?</p><h3 id="tocexternal-hardware">1. External hardware</h3><p>First of all, you need external hardware. If you're using a breadboard, no problem, you just need a couple more wires and you're good to go. But I have a nice <a href="https://www.banggood.com/M5CameraF-ESP32-Fish-eye-Camera-Development-Board-Module-OV2640-Mini-Fisheye-Camera-Unit-Demoboard-p-1496820.html?rmmds=search&cur_warehouse=CN">M5stick camera</a> (no affiliate link), that's already well packaged, so it won't be that easy to add a PIR sensor.</p><h3 id="tocfield-of-view">2. Field of View</h3><p>PIR sensors have a limited FOV (field of view), so you will need more than one to cover the whole range of the camera.</p><p>My camera, for example, has fish-eye lens which give me 160Â° of view. Most cheap PIR sensors have a 120Â° field of view, so one will not suffice. This adds even more space to my project.</p><h3 id="toccold-objects">3. Cold objects</h3><p>PIR sensors gets triggered by infrared light. Infrared light gets emitted by hot bodies (like people and animals).</p><p>But motion in a video stream can happen for a variety of reasons, not necessarily due to hot bodies, for example if you want to monitor a street for cars passing by.</p><p>A PIR sensor can't do this: video motion detection can.</p> <span class="bctt-click-to-tweet"><span class="bctt-ctt-text"><a href="https://twitter.com/intent/tweet?url=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fmotion-detection-with-esp32-cam-only-arduino-version%2F&text=ESP32%20cam%20pure%20video%20motion%20detection%20can%20detect%20motion%20due%20to%20cold%20objects&via=EloquentArduino&related=EloquentArduino" target="_blank" rel="noopener noreferrer">ESP32 cam pure video motion detection can detect motion due to cold objects </a></span><a href="https://twitter.com/intent/tweet?url=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fmotion-detection-with-esp32-cam-only-arduino-version%2F&text=ESP32%20cam%20pure%20video%20motion%20detection%20can%20detect%20motion%20due%20to%20cold%20objects&via=EloquentArduino&related=EloquentArduino" target="_blank" class="bctt-ctt-btn" rel="noopener noreferrer">Click To Tweet</a></span><div class="infobox"> Do you like the motion effect at the beginning of the post? <a href="https://gist.github.com/eloquentarduino/6bb0b26a3900d7fac68b2f3cc7b2c688">Check it out on Github</a></div><h2 id="tocwhat-do-you-need">What do you need?</h2><p>All you need for this project is a board with a camera sensor. As I said, I have a M5Stick Camera with fish-eye lens, but any ESP32 based camera should work out of the box:</p><ul><li>ESP32 cam</li><li>ESP32 eye</li><li>TTGO camera</li><li>... any other flavor of ESP32 camera</li></ul><p><noscript><img src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-models.jpg" alt="ESP32 camera models"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20%20%22%3E%3C/svg%3E" data-src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-models.jpg" alt="ESP32 camera models"></p><h2 id="tochow-does-it-work">How does it work?</h2><p>Ok, let's go to the "technical" stuff.</p><p>Simply put, the algorithm counts the number of different pixels from one frame to the next: if many pixels changed, it will detect motion.</p><p>Well, it's <em>almost</em> like this.</p><p>Of course such an algorithm will be very sensitive to noise (which is quite high on these low-cost cameras). We need to mitigate false-positive triggers.</p><h3 id="tocdownsampling">Downsampling</h3><p>One super-simple and super-effective way of doing this is to <strong>work with blocks</strong>, instead of pixels. A block is simply an N x N square, whose value is the average of the pixels it contains.</p><p>This greatly reduces sensitivity to noise, providing a more robust detection. Here's an example of what the the "block-ing" operation does to an image.</p><p><noscript><img src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/Image-downsampling-example.jpg" alt="Image downsampling example"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20%20%22%3E%3C/svg%3E" data-src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/Image-downsampling-example.jpg" alt="Image downsampling example"></p><p>It's really a "pixelating" effect: you take the orginal image (let's say 320x240 pixels) and resize it to 10x smaller, 32x24.</p><p>This has the added benefit that it's much more lightweight to work with 32x24 matrix instead of 320x240 matrix: if you want to do real-time detection, this is a MUST.</p><p>How should you choose the scale factor?</p><p>Well, it depends.</p><p>It depends on the sensitivity you want to achieve. The higher the downsampling, the less sensitive your detection will be.</p><p>If you want to detect a person passing 50cm away from the camera, you can increase this number without any problem. If you want to detect a dog 10m away, you should keep it in the 5-10 range.</p><p>Experiment with your own use case a tweak with trial-and-error.</p><h3 id="tocblocks-difference-threshold">Blocks difference threshold</h3><p>Once we've defined the block size, we need to detect if a block changed from one frame to the next.</p><p>Of course, just testing for difference (<code>current != prev</code>) would be again too sensitive to noise. A block can change for a variety of reasons, the first of which is the bad camera quality.</p><p>So we instead define a percent threshold above which we can say for sure the block actually changed. A good starting point could be 10-20%, but again you need to tweak this to your needs.</p><p>The higher the threshold, the less sensitive the algorithm will be.</p><p>In code it is calculated as</p><pre><code class="language-cpp">float delta = abs(currentBlockValue - prevBlockValue) / prevBlockValue;</code></pre><p>which indicates the relative increment/decrement from the previous value.</p><h3 id="tocimage-difference-threshold">Image difference threshold</h3><p>Now that we can detect if a block changed from one frame to the next, we can actually detect if the image changed.</p><p>You could decide to trigger motion even if a single block changed, but I suggest you to set an higher value here.</p><p>Let's return to the 320x240 image example. With a 10x10 block, you'll be working with <code>32x24 = 768</code> blocks: will you call it "motion" if 1 out of 768 blocks changed value?</p><p>I don't think so. You want something more robust. You want 50 blocks to change. Or at least 20 blocks. If you do the math, 20 blocks out of 768 is only the 2.5% of change, which is hardly noticeable.</p><p>If you want to be robust, don't set this threshold to a too low value. Again, tweak with real world experimenting.</p><p>In code it is calculated as:</p><pre><code class="language-cpp">float changedBlocksPercent = changedBlocks / totalBlocks</code></pre><h3 id="toccombining-all-together">Combining all together</h3><p>Recapping: when running the motion detection algorithm you have 3 parameters to set:</p><ol><li>the block size</li><li>the block difference threshold</li><li>the image differerence threshold</li></ol><p>Let's pick 3 sensible defaults: <code>block size = 10</code>, <code>block threshold = 15%</code>, <code>image threshold = 20%</code>.</p><p>What does these parameters translate to in the practice?</p><p>They mean that motion will be detected if <code>20% of the image, averaged in blocks of 10x10, changed its value by at least 15% from one frame to the next</code>.</p><p><noscript><img src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-motion-example.jpg" alt="ESP32 camera motion example"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20%20%22%3E%3C/svg%3E" data-src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-motion-example.jpg" alt="ESP32 camera motion example"></p><p>As you can see, you don't need high-definition images to (naively) detect if something happened to the image. Large area of motion will be easily detectable, even at very low resolution.</p><h2 id="tocreal-world-example">Real world example</h2><p>Now the fun part. I'll show you how it performs on a real-world scenario.</p><p>To keep it simple, I wrote a sketch that does only motion detection, not video streaming over HTTP.</p><p>This means you won't be able to see the original image recorded from the camera. Nevertheless, I have kept the block size to a minimum to allow for the best quality possible.</p><div style="width: 652px;" class="wp-video"><video class="wp-video-shortcode" id="video-779-1" width="652" height="604" preload="metadata" controls="controls"><source type="video/mp4" src="https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-motion-detection-example.mp4?_=1"></source><a href="https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-motion-detection-example.mp4">https://eloquentarduino.github.io/wp-content/uploads/2020/01/ESP32-camera-motion-detection-example.mp4</a></video></div><p>This is me passing my arm in front of the camera a few times.</p><p>The grid you see represents the actual pixels used for the computation. Each cell corresponds to one pixel of the downscaled image.</p><p>The orange cells highlight the pixels that the algorithm sees as "different" from one frame to the next. As you can see, some pixels are detected even if no motion is happening. That's the noise I talked about multiple times during the post.</p><p>When I move my arm in the frame, you see lots of pixels become activated, so the "Motion" text appears.</p><p>While moving the arm, you may notice what I call the "ghost" effect. You actually see 2 regions of motion: one is where my arm is now, which of course changed. The other is the region where my arm was in the previous frame, which returned to its original content.</p><p>This is why I suggest you keep the <code>image difference threshold</code> to a high value: if some real motion happens, you will notice it for sure because the activated region of the image will be actually bigger than the actual object moving.</p><p>Do you like the grid effect of the sample video? Let me know in the comment if you want me to share it.</p><p>Or even better: subscribe to the newsletter I you will get it directly in your inbox with my next mail.</p><div id="mc_embed_signup"><form action="https://github.us4.list-manage.com/subscribe/post?u=f0eaedd94d554cf2ee781742a&id=37d3496031" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate><div id="mc_embed_signup_scroll"><h2 style="margin: 0; text-align: center">Finding this content useful?</h2><div class="mc-field-group"> <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="join the monthly newsletter"></div><div id="mce-responses" class="clear"><div class="response" id="mce-error-response" style="display:none"></div><div class="response" id="mce-success-response" style="display:none"></div></div><div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_f0eaedd94d554cf2ee781742a_37d3496031" tabindex="-1" value=""></div><div class="clear" style="position: relative; top: 8px"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div></div></form></div><hr><p>Check the full project code on <a href="https://github.com/eloquentarduino/EloquentArduino/blob/master/examples/ESP32CameraNaiveMotionDetection/ESP32CameraNaiveMotionDetection.ino" target="_blank" rel="noopener noreferrer">Github</a></p><p>Check out also the <a href="https://gist.github.com/eloquentarduino/6bb0b26a3900d7fac68b2f3cc7b2c688">gist for the visualization tool</a></p></div><div class="heateorSssClear"></div><div class="heateor_sss_sharing_container heateor_sss_horizontal_sharing" heateor-sss-data-href="https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/"><div class="heateor_sss_sharing_title" style="font-weight:bold">Help the blow grow</div><ul class="heateor_sss_sharing_ul"><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" alt="Facebook" title="Facebook" class="heateorSssSharing heateorSssFacebookBackground" onclick='heateorSssPopup("https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fmotion-detection-with-esp32-cam-only-arduino-version%2F")'><ss style="display:block;border-radius:999px;" class="heateorSssSharingSvg heateorSssFacebookSvg"></ss></i></li><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" alt="Twitter" title="Twitter" class="heateorSssSharing heateorSssTwitterBackground" onclick='heateorSssPopup("http://twitter.com/intent/tweet?via=ArduinoEloquent&text=Motion%20detection%20with%20ESP32%20camera%20only%20%28Arduino%20version%29&url=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fmotion-detection-with-esp32-cam-only-arduino-version%2F")'><ss style="display:block;border-radius:999px;" class="heateorSssSharingSvg heateorSssTwitterSvg"></ss></i></li><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" alt="Linkedin" title="Linkedin" class="heateorSssSharing heateorSssLinkedinBackground" onclick='heateorSssPopup("http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fmotion-detection-with-esp32-cam-only-arduino-version%2F&title=Motion%20detection%20with%20ESP32%20cam%20only%20%28Arduino%20version%29")'><ss style="display:block;border-radius:999px;" class="heateorSssSharingSvg heateorSssLinkedinSvg"></ss></i></li><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" title="More" alt="More" class="heateorSssSharing heateorSssMoreBackground" onclick="heateorSssMoreSharingPopup(this, 'https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/', 'Motion%20detection%20with%20ESP32%20cam%20only%20%28Arduino%20version%29', 'Motion%20detection%20with%20ESP32%20camera%20only%20%28Arduino%20version%29' )"><ss style="display:block" class="heateorSssSharingSvg heateorSssMoreSvg"></ss></i></li></ul><div class="heateorSssClear"></div></div><div class="heateorSssClear"></div><div class="heateor_sss_sharing_container heateor_sss_vertical_sharing heateor_sss_bottom_sharing" style="width:44px;right: -10px;top: 100px;-webkit-box-shadow:none;box-shadow:none;" heateor-sss-data-href="https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/"><ul class="heateor_sss_sharing_ul"><li class=""><i style="width:40px;height:40px;margin:0;" alt="Facebook" title="Facebook" class="heateorSssSharing heateorSssFacebookBackground" onclick='heateorSssPopup("https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fmotion-detection-with-esp32-cam-only-arduino-version%2F")'><ss style="display:block;" class="heateorSssSharingSvg heateorSssFacebookSvg"></ss></i></li><li class=""><i style="width:40px;height:40px;margin:0;" alt="Twitter" title="Twitter" class="heateorSssSharing heateorSssTwitterBackground" onclick='heateorSssPopup("http://twitter.com/intent/tweet?via=ArduinoEloquent&text=Motion%20detection%20with%20ESP32%20camera%20only%20%28Arduino%20version%29&url=http%3A%2F%2Feloquent.blog%2F2020%2F01%2Fmotion-detection-with-esp32-cam-only-arduino-version%2F")'><ss style="display:block;" class="heateorSssSharingSvg heateorSssTwitterSvg"></ss></i></li><li class=""><i style="width:40px;height:40px;margin:0;" title="More" alt="More" class="heateorSssSharing heateorSssMoreBackground" onclick="heateorSssMoreSharingPopup(this, 'https://eloquentarduino.github.io/2020/01/motion-detection-with-esp32-cam-only-arduino-version/', 'Motion%20detection%20with%20ESP32%20cam%20only%20%28Arduino%20version%29', 'Motion%20detection%20with%20ESP32%20camera%20only%20%28Arduino%20version%29' )"><ss style="display:block" class="heateorSssSharingSvg heateorSssMoreSvg"></ss></i></li></ul><div class="heateorSssClear"></div></div><div class="crp_related  "><h3>Related Posts</h3><ul><li><a href="https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/" class="post-820"><span class="crp_title">Apple or Orange? Image recognition with ESP32 and Arduino</span></a></li><li><a href="https://eloquentarduino.github.io/2020/02/easy-arduino-thermal-camera-with-ascii-video-streaming/" class="post-956"><span class="crp_title">Easy Arduino thermal camera with (ASCII) video streaming</span></a></li><li><a href="https://eloquentarduino.github.io/2020/02/handwritten-digit-classification-with-arduino-and-microml/" class="post-931"><span class="crp_title">Handwritten digit classification with Arduino and MicroML</span></a></li></ul><div class="crp_clear"></div></div><div id="disqus_thread"></div></div><div class="clear"></div></div></div></div><div class="post-meta-bottom"><div class="post-cat-tags"><p class="post-categories"><span>Categories:</span> <a href="https://eloquentarduino.github.io/category/programming/computer-vision/" rel="category tag">Computer vision</a></p><p class="post-tags">Tags: <a href="https://eloquentarduino.github.io/tag/camera/" rel="tag">camera</a>, <a href="https://eloquentarduino.github.io/tag/esp32/" rel="tag">esp32</a></p></div><div class="archive-nav post-nav"> <a class="post-nav-older" title="Previous post: Embedded Machine learning on Attiny85" href="https://eloquentarduino.github.io/2019/12/machine-learning-on-attiny85/"> Â« Embedded Machine learning on Attiny85 </a> <a class="post-nav-newer" title="Next post: Apple or Orange? Image recognition with ESP32 and Arduino" href="https://eloquentarduino.github.io/2020/01/image-recognition-with-esp32-and-arduino/"> Apple or Orange? Image recognition with ESP32 and Arduino Â» </a><div class="clear"></div></div></div><p class="nocomments">Comments are closed.</p><div class="footer section large-padding bg-dark"><div class="clear"></div></div><div class="credits"><div class="credits-inner"><p class="credits-left">Â© 2020 <a href="https://eloquentarduino.github.io" title="Eloquent Arduino Blog">Eloquent Arduino Blog</a></p><p class="credits-right"><span>Theme by <a href="https://www.andersnoren.se">Anders NorÃ©n</a></span> â€” <a title="To the top" class="tothetop">Up â†‘</a></p><div class="clear"></div></div></div></div><div class="clear"></div></div> <script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script> <script src="//cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-154550080-1"></script> <script>if (window.location.href.indexOf("eloquent.blog") < 0) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154550080-1');
}</script>  <script>(function() {
setTimeout(function() {
  var d = document, s = d.createElement('script');
  s.src = 'https://eloquent-arduino.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);},
10000);
})();</script>  <noscript><style>.lazyload{display:none;}</style></noscript><script data-noptimize="1">window.lazySizesConfig=window.lazySizesConfig||{};window.lazySizesConfig.loadMode=1;</script><script async data-noptimize="1" src="https://eloquentarduino.github.io/wp-content/plugins/autoptimize/classes/external/js/lazysizes.min.js"></script> <link rel="stylesheet" id="fontawesome5-css" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" type="text/css" media="all"> <script type="text/javascript">function heateorSssLoadEvent(e) {var t=window.onload;if (typeof window.onload!="function") {window.onload=e}else{window.onload=function() {t();e()}}};	var heateorSssSharingAjaxUrl = 'https://eloquentarduino.github.io/wp-admin/admin-ajax.php', heateorSssCloseIconPath = 'https://eloquentarduino.github.io/wp-content/plugins/sassy-social-share/public/../images/close.png', heateorSssPluginIconPath = 'https://eloquentarduino.github.io/wp-content/plugins/sassy-social-share/public/../images/logo.png', heateorSssHorizontalSharingCountEnable = 0, heateorSssVerticalSharingCountEnable = 0, heateorSssSharingOffset = -10; var heateorSssMobileStickySharingEnabled = 1;var heateorSssCopyLinkMessage = "Link copied.";var heateorSssUrlCountFetched = [], heateorSssSharesText = 'Shares', heateorSssShareText = 'Share';function heateorSssPopup(e) {window.open(e,"popUpWindow","height=400,width=600,left=400,top=100,resizable,scrollbars,toolbar=0,personalbar=0,menubar=no,location=no,directories=no,status")};var heateorSssWhatsappShareAPI = "web";</script> <script type="text/javascript" src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill.min.js"></script> <script type="text/javascript">( 'fetch' in window ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-fetch.min.js?ver=3.0.0">' + 'ipt>' );( document.contains ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-node-contains.min.js?ver=3.26.0-0">' + 'ipt>' );( window.FormData && window.FormData.prototype.keys ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-formdata.min.js?ver=3.0.12">' + 'ipt>' );( Element.prototype.matches && Element.prototype.closest ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-element-closest.min.js?ver=2.0.2">' + 'ipt>' );</script> <script type="text/javascript" src="https://eloquentarduino.github.io/wp-includes/js/dist/i18n.min.js"></script> <script type="text/javascript">var highlight_and_share = {"show_facebook":"1","show_twitter":"1","show_linkedin":"1","show_pinterest":"","show_email":"","show_xing":"","show_copy":"","show_whatsapp":"","twitter_username":"EloquentArduino","twitter_fa_class":"fa fa-twitter","facebook_fa_class":"fa fa-facebook","linkedin_fa_class":"fa fa-linkedin","pinterest_fa_class":"fa fa-pinterest","xing_fa_class":"fa fa-xing","whatsapp_fa_class":"fa fa-whatsapp","copy_fa_class":"fa fa-copy","email_fa_class":"fa fa-envelope","mobile":"","content":".has-content-area","tweet_text":"Tweet","facebook_text":"Share","linkedin_text":"LinkedIn","pinterest_text":"Pinterest","whatsapp_text":"WhatsApp","xing_text":"Xing","copy_text":"Copy","email_text":"E-mail","icons":"1","facebook_app_id":"2530754057166153","email_your_name_value":"","email_from_value":"","nonce":"5b2aacd45a","ajax_url":"https:\/\/eloquentarduino.github.io\/wp-admin\/admin-ajax.php","email_share":"Share This Post Via Email","email_subject":"Your Subject","email_your_name":"Your Name","email_send_email":"Send to Email Address","email_subject_text":"[Shared Post] %title%","email_from":"Your Email Address","email_send":"Send Email","email_cancel":"Cancel","email_close":"Close","email_loading":"https:\/\/eloquentarduino.github.io\/wp-content\/plugins\/highlight-and-share\/img\/loading.gif","email_subject_error":"You must fill in a subject.","email_email_to":"Send to Email Address is blank.","email_email_from":"Your email address is blank.","email_email_name":"Your name is blank.","email_sending":"Sending...","customizer_preview":""};</script> <script type="text/javascript">( function( domain, translations ) {
	var localeData = translations.locale_data[ domain ] || translations.locale_data.messages;
	localeData[""].domain = domain;
	wp.i18n.setLocaleData( localeData, domain );
} )( "highlight-and-share", { "locale_data": { "messages": { "": {} } } } );</script> <script type="text/javascript">var mejsL10n = {"language":"en","strings":{"mejs.install-flash":"You are using a browser that does not have Flash player enabled or installed. Please turn on your Flash player plugin or download the latest version from https:\/\/get.adobe.com\/flashplayer\/","mejs.fullscreen-off":"Turn off Fullscreen","mejs.fullscreen-on":"Go Fullscreen","mejs.download-video":"Download Video","mejs.fullscreen":"Fullscreen","mejs.time-jump-forward":["Jump forward 1 second","Jump forward %1 seconds"],"mejs.loop":"Toggle Loop","mejs.play":"Play","mejs.pause":"Pause","mejs.close":"Close","mejs.time-slider":"Time Slider","mejs.time-help-text":"Use Left\/Right Arrow keys to advance one second, Up\/Down arrows to advance ten seconds.","mejs.time-skip-back":["Skip back 1 second","Skip back %1 seconds"],"mejs.captions-subtitles":"Captions\/Subtitles","mejs.captions-chapters":"Chapters","mejs.none":"None","mejs.mute-toggle":"Mute Toggle","mejs.volume-help-text":"Use Up\/Down Arrow keys to increase or decrease volume.","mejs.unmute":"Unmute","mejs.mute":"Mute","mejs.volume-slider":"Volume Slider","mejs.video-player":"Video Player","mejs.audio-player":"Audio Player","mejs.ad-skip":"Skip ad","mejs.ad-skip-info":["Skip in 1 second","Skip in %1 seconds"],"mejs.source-chooser":"Source Chooser","mejs.stop":"Stop","mejs.speed-rate":"Speed Rate","mejs.live-broadcast":"Live Broadcast","mejs.afrikaans":"Afrikaans","mejs.albanian":"Albanian","mejs.arabic":"Arabic","mejs.belarusian":"Belarusian","mejs.bulgarian":"Bulgarian","mejs.catalan":"Catalan","mejs.chinese":"Chinese","mejs.chinese-simplified":"Chinese (Simplified)","mejs.chinese-traditional":"Chinese (Traditional)","mejs.croatian":"Croatian","mejs.czech":"Czech","mejs.danish":"Danish","mejs.dutch":"Dutch","mejs.english":"English","mejs.estonian":"Estonian","mejs.filipino":"Filipino","mejs.finnish":"Finnish","mejs.french":"French","mejs.galician":"Galician","mejs.german":"German","mejs.greek":"Greek","mejs.haitian-creole":"Haitian Creole","mejs.hebrew":"Hebrew","mejs.hindi":"Hindi","mejs.hungarian":"Hungarian","mejs.icelandic":"Icelandic","mejs.indonesian":"Indonesian","mejs.irish":"Irish","mejs.italian":"Italian","mejs.japanese":"Japanese","mejs.korean":"Korean","mejs.latvian":"Latvian","mejs.lithuanian":"Lithuanian","mejs.macedonian":"Macedonian","mejs.malay":"Malay","mejs.maltese":"Maltese","mejs.norwegian":"Norwegian","mejs.persian":"Persian","mejs.polish":"Polish","mejs.portuguese":"Portuguese","mejs.romanian":"Romanian","mejs.russian":"Russian","mejs.serbian":"Serbian","mejs.slovak":"Slovak","mejs.slovenian":"Slovenian","mejs.spanish":"Spanish","mejs.swahili":"Swahili","mejs.swedish":"Swedish","mejs.tagalog":"Tagalog","mejs.thai":"Thai","mejs.turkish":"Turkish","mejs.ukrainian":"Ukrainian","mejs.vietnamese":"Vietnamese","mejs.welsh":"Welsh","mejs.yiddish":"Yiddish"}};</script> <script type="text/javascript">var _wpmejsSettings = {"pluginPath":"\/wp-includes\/js\/mediaelement\/","classPrefix":"mejs-","stretching":"responsive"};</script> <script defer src="https://eloquentarduino.github.io/wp-content/cache/autoptimize/js/autoptimize_95be73cabdced0272b689716cbb96c44.js"></script><script data-cfasync="false">!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){function e(){t.media=a}var a=t.media||"all";t.addEventListener?t.addEventListener("load",e):t.attachEvent&&t.attachEvent("onload",e),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(e,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);</script></body></html>
