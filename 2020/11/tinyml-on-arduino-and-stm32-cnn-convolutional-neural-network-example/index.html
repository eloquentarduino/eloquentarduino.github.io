<!DOCTYPE html>
<html lang="en-US"><head profile="http://gmpg.org/xfn/11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta property="og:title" content="TinyML on Arduino and STM32: CNN (Convolutional Neural Network) example"><meta property="og:description" content="Painless TinyML Convolutional Neural Network on your Arduino and STM32 boards: the MNIST dataset example!  Are you fascinated by TinyML and Tensorflow for mic"><meta property="og:image" content="https://eloquentarduino.github.io/wp-content/uploads/2020/11/CNN-topology.png"><meta property="og:image:width" content="1040"><meta property="og:image:height" content="320"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="TinyML on Arduino and STM32: CNN (Convolutional Neural Network) example"><meta name="twitter:description" content="Painless TinyML Convolutional Neural Network on your Arduino and STM32 boards: the MNIST dataset example!  Are you fascinated by TinyML and Tensorflow for mic"><meta name="twitter:image" content="https://eloquentarduino.github.io/wp-content/uploads/2020/11/CNN-topology.png"><meta name="author" content="simone"><link rel="stylesheet" media="print" onload="this.onload=null;this.media='all';" id="ao_optimized_gfonts" href="https://fonts.googleapis.com/css?family=Lato%3A400%2C700%2C400italic%2C700italic%7CLato:400,700&display=swap"><link media="all" href="https://eloquentarduino.github.io/wp-content/cache/autoptimize/css/autoptimize_a472e90631480a21513db05693ae6925.css" rel="stylesheet"><title>TinyML on Arduino and STM32: CNN (Convolutional Neural Network) example</title><meta name="robots" content="index, follow"><meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/"><meta property="og:site_name" content="Eloquent Arduino Blog"><meta property="article:published_time" content="2020-11-10T16:37:13+00:00"><meta property="article:modified_time" content="2020-11-10T18:10:06+00:00"><meta property="og:image" content="https://eloquentarduino.github.io/wp-content/uploads/2020/11/CNN-topology.png"><meta property="og:image:width" content="1040"><meta property="og:image:height" content="320"> <script type="application/ld+json" class="yoast-schema-graph">{"@context":"https://schema.org","@graph":[{"@type":"WebSite","@id":"https://eloquentarduino.github.io/#website","url":"https://eloquentarduino.github.io/","name":"Eloquent Arduino Blog","description":"Machine learning on Arduino, programming & electronics","publisher":{"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901"},"potentialAction":[{"@type":"SearchAction","target":"https://eloquentarduino.github.io/?s={search_term_string}","query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/#primaryimage","inLanguage":"en-US","url":"https://eloquentarduino.github.io/wp-content/uploads/2020/11/CNN-topology.png","width":1040,"height":320,"caption":"CNN topology"},{"@type":"WebPage","@id":"https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/#webpage","url":"https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/","name":"TinyML on Arduino and STM32: CNN (Convolutional Neural Network) example","isPartOf":{"@id":"https://eloquentarduino.github.io/#website"},"primaryImageOfPage":{"@id":"https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/#primaryimage"},"datePublished":"2020-11-10T16:37:13+00:00","dateModified":"2020-11-10T18:10:06+00:00","inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/"]}]},{"@type":"Article","@id":"https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/#article","isPartOf":{"@id":"https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/#webpage"},"author":{"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901"},"headline":"TinyML on Arduino and STM32: CNN (Convolutional Neural Network) example","datePublished":"2020-11-10T16:37:13+00:00","dateModified":"2020-11-10T18:10:06+00:00","mainEntityOfPage":{"@id":"https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/#webpage"},"publisher":{"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901"},"image":{"@id":"https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/#primaryimage"},"articleSection":"Senza categoria","inLanguage":"en-US"},{"@type":["Person","Organization"],"@id":"https://eloquentarduino.github.io/#/schema/person/c35265597251f0133ecca5b413d12901","name":"simone","image":{"@type":"ImageObject","@id":"https://eloquentarduino.github.io/#personlogo","inLanguage":"en-US","url":"https://eloquentarduino.github.io/wp-content/uploads/2019/12/avatar.jpg","width":330,"height":330,"caption":"simone"},"logo":{"@id":"https://eloquentarduino.github.io/#personlogo"}}]}</script> <link rel="dns-prefetch" href="//use.fontawesome.com"><link rel="dns-prefetch" href="//s.w.org"><link href="https://fonts.gstatic.com" crossorigin="anonymous" rel="preconnect"><link rel="stylesheet" id="font-awesome-official-css" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css" type="text/css" media="all" integrity="sha384-REHJTs1r2ErKBuJB0fCK99gCYsVjwxHrSU0N7I1zl9vZbggVJXRMsv/sLlOAGb4M" crossorigin="anonymous"><link rel="stylesheet" id="font-awesome-official-v4shim-css" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css" type="text/css" media="all" integrity="sha384-AL44/7DEVqkvY9j8IjGLGZgFmHAjuHa+2RIWKxDliMNIfSs9g14/BRpYwHrWQgz6" crossorigin="anonymous"> <script type="text/javascript" src="https://eloquentarduino.github.io/wp-includes/js/jquery/jquery.js"></script> <meta name="google-site-verification" content="xgigjPrbbYDemskTaGLT9WGhmw8wgdeFtpDxVak0awI"></head><body class="post-template-default single single-post postid-1365 single-format-standard has-body"><div class="wrapper"><div class="sidebar"><div class="blog-header"> <a class="blog-logo" href="https://eloquentarduino.github.io" title="Eloquent Arduino Blog — Machine learning on Arduino, programming & electronics" rel="home"> <noscript><img src="https://eloquentarduino.github.io/wp-content/uploads/2019/12/logo-completo.png" alt="Eloquent Arduino Blog"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="https://eloquentarduino.github.io/wp-content/uploads/2019/12/logo-completo.png" alt="Eloquent Arduino Blog"> </a></div><div class="nav-toggle toggle"><p> <span class="show">Show menu</span> <span class="hide">Hide menu</span></p><div class="bars"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="clear"></div></div></div><div class="blog-menu"><ul class="navigation"><li id="menu-item-461" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-461"><a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/">Arduino Machine learning</a></li><li id="menu-item-462" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-462"><a href="https://eloquentarduino.github.io/category/programming/eloquent-library/">Eloquent library</a></li></ul><div class="clear"></div></div><div class="mobile-menu"><ul class="navigation"><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-461"><a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/">Arduino Machine learning</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-462"><a href="https://eloquentarduino.github.io/category/programming/eloquent-library/">Eloquent library</a></li></ul></div><div class="widgets" role="complementary"><div class="widget_text widget widget_custom_html"><div class="widget_text widget-content"><div class="textwidget custom-html-widget"><div style="text-align: center"> <noscript><img src="/wp-content/uploads/2020/04/profilo.png" alt="Profile pic" style="width: 125px"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="/wp-content/uploads/2020/04/profilo.png" alt="Profile pic" style="width: 125px"> <a href="/about-me" style="display: block; font-size: 18px">About me</a></div></div></div><div class="clear"></div></div><div class="widget widget_search"><div class="widget-content"><form method="get" class="searchform" action="https://eloquentarduino.github.io" id="searchform"><div role="search" class="searchbox__wrapper"> <input id="search-input" type="search" name="search" placeholder="Search the blog" autocomplete="off" required="required" class="searchbox__input"> <button type="submit" title="Submit your search query." class="searchbox__submit"> <svg role="img" aria-label="Search"> <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#sbx-icon-search-13"></use> </svg> </button> <button type="reset" title="Clear the search query." class="searchbox__reset hide"> <svg role="img" aria-label="Reset"> <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#sbx-icon-clear-3"></use> </svg> </button></div></form></div><div class="clear"></div></div><div class="widget widget_recent_entries"><div class="widget-content"><h3 class="widget-title">Recent Posts</h3><ul><li> <a href="https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/" aria-current="page">TinyML on Arduino and STM32: CNN (Convolutional Neural Network) example</a></li><li> <a href="https://eloquentarduino.github.io/2020/10/decision-tree-random-forest-and-xgboost-on-arduino/">Decision Tree, Random Forest and XGBoost on Arduino</a></li><li> <a href="https://eloquentarduino.github.io/2020/09/principal-fft-components-as-efficient-features-extrator/">“Principal” FFT components as efficient features extrator</a></li><li> <a href="https://eloquentarduino.github.io/2020/08/better-word-classification-with-arduino-33-ble-sense-and-machine-learning/">Better word classification with Arduino Nano 33 BLE Sense and Machine Learning</a></li><li> <a href="https://eloquentarduino.github.io/2020/08/the-ultimate-guide-to-wifi-indoor-positioning-using-arduino-and-machine-learning/">The Ultimate Guide to Wifi Indoor Positioning using Arduino and Machine Learning</a></li></ul></div><div class="clear"></div></div><div class="widget widget_sub_categories"><div class="widget-content"><h3 class="widget-title">Programming</h3><ul><li class="cat-item cat-item-8"><a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/">Arduino Machine learning</a><ul class="children"><li class="cat-item cat-item-24"><a href="https://eloquentarduino.github.io/category/programming/arduino-machine-learning/arduino-machine-learning-tutorial/">Arduino Machine Learning tutorial</a></li></ul></li><li class="cat-item cat-item-12"><a href="https://eloquentarduino.github.io/category/programming/computer-vision/">Computer vision</a></li><li class="cat-item cat-item-7"><a href="https://eloquentarduino.github.io/category/programming/eloquent-library/">Eloquent library</a></li></ul></div><div class="clear"></div></div><div class="widget widget_tag_cloud"><div class="widget-content"><h3 class="widget-title">TAGS</h3><div class="tagcloud"><a href="https://eloquentarduino.github.io/tag/camera/" class="tag-cloud-link tag-link-11 tag-link-position-1" style="font-size: 14.222222222222pt;" aria-label="camera (5 items)">camera</a> <a href="https://eloquentarduino.github.io/tag/eloquent/" class="tag-cloud-link tag-link-4 tag-link-position-2" style="font-size: 11.888888888889pt;" aria-label="eloquent (3 items)">eloquent</a> <a href="https://eloquentarduino.github.io/tag/esp32/" class="tag-cloud-link tag-link-10 tag-link-position-3" style="font-size: 14.222222222222pt;" aria-label="esp32 (5 items)">esp32</a> <a href="https://eloquentarduino.github.io/tag/incremental-learning/" class="tag-cloud-link tag-link-16 tag-link-position-4" style="font-size: 8pt;" aria-label="incremental-learning (1 item)">incremental-learning</a> <a href="https://eloquentarduino.github.io/tag/microml/" class="tag-cloud-link tag-link-5 tag-link-position-5" style="font-size: 22pt;" aria-label="microml (23 items)">microml</a> <a href="https://eloquentarduino.github.io/tag/ml/" class="tag-cloud-link tag-link-17 tag-link-position-6" style="font-size: 14.222222222222pt;" aria-label="ml (5 items)">ml</a> <a href="https://eloquentarduino.github.io/tag/online-learning/" class="tag-cloud-link tag-link-15 tag-link-position-7" style="font-size: 10.333333333333pt;" aria-label="online-learning (2 items)">online-learning</a> <a href="https://eloquentarduino.github.io/tag/pca/" class="tag-cloud-link tag-link-21 tag-link-position-8" style="font-size: 8pt;" aria-label="pca (1 item)">pca</a> <a href="https://eloquentarduino.github.io/tag/rvm/" class="tag-cloud-link tag-link-13 tag-link-position-9" style="font-size: 8pt;" aria-label="rvm (1 item)">rvm</a> <a href="https://eloquentarduino.github.io/tag/svm/" class="tag-cloud-link tag-link-14 tag-link-position-10" style="font-size: 18.111111111111pt;" aria-label="svm (11 items)">svm</a> <a href="https://eloquentarduino.github.io/tag/tinyml/" class="tag-cloud-link tag-link-20 tag-link-position-11" style="font-size: 8pt;" aria-label="tinyml (1 item)">tinyml</a></div></div><div class="clear"></div></div></div></div><div class="content"><div class="posts"><div id="post-1365" class="post-1365 post type-post status-publish format-standard hentry category-senza-categoria"><div class="post-inner"><div class="post-header"><h1 class="post-title"><a href="https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/" rel="bookmark" title="TinyML on Arduino and STM32: CNN (Convolutional Neural Network) example">TinyML on Arduino and STM32: CNN (Convolutional Neural Network) example</a></h1><div class="post-meta"> <span class="post-date"><a href="https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/" title="TinyML on Arduino and STM32: CNN (Convolutional Neural Network) example">10 November 2020</a></span> <span class="date-sep"> / </span> <span class="post-author"><a href="https://eloquentarduino.github.io/author/simone/" title="Posts by simone" rel="author">simone</a></span></div></div><div class="post-content"><div class="has-content-area" data-url="https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/" data-title="TinyML on Arduino and STM32: CNN (Convolutional Neural Network) example"><p>Painless TinyML Convolutional Neural Network on your Arduino and STM32 boards: the MNIST dataset example!</p><p>Are you fascinated by TinyML and Tensorflow for microcontrollers?</p><p>Do you want to run a CNN (Convolutional Neural Network) on your Arduino and STM32 boards?</p><p>Do you want to do it without pain?</p><p>EloquentTinyML is the library for you!</p><p><noscript><img src="https://eloquentarduino.github.io/wp-content/uploads/2020/11/CNN-topology.png" alt="CNN topology"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="https://eloquentarduino.github.io/wp-content/uploads/2020/11/CNN-topology.png" alt="CNN topology"></p><p><span id="more-1365"></span></p><p><a href="https://github.com/eloquentarduino/EloquentTinyML">EloquentTinyML</a>, my library to easily run Tensorflow Lite neural networks on Arduino microcontrollers, is gaining some popularity so I think it's time for a good tutorial on the topic.</p><p>If you're a seasoned follower of my blog, you may know that I don't really like Tensorflow on microcontrollers, because it is often <em>"over-sized"</em> for the project at hand and there are <a href="/2020/08/eloquentml-grows-its-family-of-classifiers-gaussian-naive-bayes-on-arduino/">leaner</a>, <a href="/2020/07/sefr-a-fast-linear-time-classifier-for-ultra-low-power-devices/">faster</a> <a href="/2020/10/decision-tree-random-forest-and-xgboost-on-arduino/">alternatives</a>.</p><p>Nonetheless, Tensorflow is gaining much popularity in the embedded world so I'll try to give my contribute too.</p><p>In this tutorial, I'm going to show you <strong>step by step</strong> how to train a CNN in Tensorflow and deploy it to you board: I tested the code both on the <strong>Arduino Nano 33 BLE Sense</strong> and the <strong>STM32 Nucleus L432KC</strong>.</p><p></p><div class="toc"><h6>Table of contents</h6><ol><li><a href="#tochow-to-train-a-cnn-in-tensorflow">How to train a CNN in Tensorflow</a><ol><li><a href="#tocstep-1-import-the-libraries">Step 1. Import the libraries</a></li><li><a href="#tocstep-2-generate-train-validation-and-test-data">Step 2. Generate train, validation and test data</a></li><li><a href="#tocstep-3-create-and-train-the-model">Step 3. Create and train the model</a></li><li><a href="#tocstep-4-testing-the-model-accuracy">Step 4. Testing the model accuracy</a></li><li><a href="#tocstep-5-exporting-the-model">Step 5. Exporting the model</a></li></ol></li><li><a href="#tochow-to-run-a-cnn-on-arduino-and-stm32-boards-with-eloquenttinyml">How to run a CNN on Arduino and STM32 boards with EloquentTinyML</a><ol><li><a href="#toccnn-on-arduino-and-stm32-figures">CNN on Arduino and STM32 figures</a></li></ol></li><li><a href="#tocand-you">And you?</a></li></ol></div><h2 id="tochow-to-train-a-cnn-in-tensorflow">How to train a CNN in Tensorflow</h2><p>I'm not an expert either in Tensorflow nor Convolutional Neural Networks, so I kept the project as simple as possible. I used an <em>image-like</em> dataset to create a setup where CNN should perform well: the dataset is the <a href="http://yann.lecun.com/exdb/mnist/">MNIST handwritten digits</a> one.</p><p><noscript><img src="https://miro.medium.com/max/800/1*LyRlX__08q40UJohhJG9Ow.png" alt="MNIST dataset example"></noscript><img class="lazyload" src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20210%20140%22%3E%3C/svg%3E" data-src="https://miro.medium.com/max/800/1*LyRlX__08q40UJohhJG9Ow.png" alt="MNIST dataset example"></p><p>It is composed by <strong>8x8</strong> images of handwritten digits, from 0 to 9 and can be easily imported via the <code>scikit-learn</code> Python package.</p><p>Regarding the CNN topology, I wanted to stay as lean as possible: the goal of this tutorial is to teach you how to deploy your own network, not about achieving 100% accuracy.</p><p>Let's see step by step how to produce a usable model.</p><h3 id="tocstep-1-import-the-libraries">Step 1. Import the libraries</h3><p>We will need <code>numpy</code> and <code>Tensorflow</code>, of course, plus <code>scikit-learn</code> to load the dataset and <a href="https://github.com/eloquentarduino/tinymlgen">tinymlgen</a> to port the CNN to plain C.</p><pre><code class="language-python">import numpy as np
from sklearn.datasets import load_digits
import tensorflow as tf
from tensorflow.keras import layers
from tinymlgen import port</code></pre><h3 id="tocstep-2-generate-train-validation-and-test-data">Step 2. Generate train, validation and test data</h3><p>To train the network, we need:</p><ul><li><code>training data</code>: this is the data the network uses to learn its weights</li><li><code>validation data</code>: this is the data the network uses to understand if it's doing well during learning</li><li><code>test data</code>: this is the data we use to test the network accuracy once it's done learning</li></ul><pre><code class="language-python">def get_data():
    np.random.seed(1337)
    x_values, y_values = load_digits(return_X_y=True)
    x_values /= x_values.max()
    # reshape to (8 x 8 x 1)
    x_values = x_values.reshape((len(x_values), 8, 8, 1))

    # split into train, validation, test
    TRAIN_SPLIT = int(0.6 * len(x_values))
    TEST_SPLIT = int(0.2 * len(x_values) + TRAIN_SPLIT)
    x_train, x_test, x_validate = np.split(x_values, [TRAIN_SPLIT, TEST_SPLIT])
    y_train, y_test, y_validate = np.split(y_values, [TRAIN_SPLIT, TEST_SPLIT])

    return x_train, x_test, x_validate, y_train, y_test, y_validate</code></pre><h3 id="tocstep-3-create-and-train-the-model">Step 3. Create and train the model</h3><p>Now we have to create our network topology.</p><p>As I stated earlier, I wanted to keep this as simple as possible (also considering that we're using a toy dataset): I added a single convolution layer (without even max pooling) followed by the output layer.</p><pre><code class="language-python">def get_model():
    x_train, x_test, x_validate, y_train, y_test, y_validate = get_data()

    # create a CNN
    model = tf.keras.Sequential()
    model.add(layers.Conv2D(8, (3, 3), activation='relu', input_shape=(8, 8, 1)))
    # model.add(layers.MaxPooling2D((2, 2)))
    model.add(layers.Flatten())
    model.add(layers.Dense(len(np.unique(y_train))))

    model.compile(optimizer='adam', loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True), metrics=['accuracy'])
    model.fit(x_train, y_train, epochs=50, batch_size=16,
                        validation_data=(x_validate, y_validate))
    return model, x_test, y_test</code></pre><h3 id="tocstep-4-testing-the-model-accuracy">Step 4. Testing the model accuracy</h3><p>Do you think this topology is too simple to learn something useful in so few epochs?</p><p>Think again: it achieved <strong>97%</strong> accuracy!</p><p>Not bad.</p><pre><code class="language-python">def test_model(model, x_test, y_test):
    x_test = (x_test / x_test.max()).reshape((len(x_test), 8, 8, 1))
    y_pred = model.predict(x_test).argmax(axis=1)

    print('ACCURACY', (y_pred == y_test).sum() / len(y_test))</code></pre><h3 id="tocstep-5-exporting-the-model">Step 5. Exporting the model</h3><p>Once we have a trained model that performs well, we want to deploy it to our microcontroller. Thanks to the <code>tinymlgen</code> packages, is as easy as a one-liner.</p><pre><code class="language-python">if __name__ == '__main__':
    model, x_test, y_test = get_model()
    test_model(model, x_test, y_test)
    c_code = port(model, variable_name='digits_model', pretty_print=True)
    print(c_code)</code></pre><h2 id="tochow-to-run-a-cnn-on-arduino-and-stm32-boards-with-eloquenttinyml">How to run a CNN on Arduino and STM32 boards with EloquentTinyML</h2><p>Ok, now we have the content we need to create an Arduino sketch to run the CNN on our microcontroller.</p><p>We will use the <code>EloquentTinyML</code> library to do this without pain.</p><p>This is a library to run TinyML models on your microcontroller without messing around with complex compilation procedures and esoteric errors.</p><p>You must first install the library at its latest version (0.0.5 or 0.0.4 if not available), either via the Library Manager or directly from Github.</p><pre><code class="language-cpp">#include <EloquentTinyML.h>

// copy the printed code from tinymlgen into this file
#include "digits_model.h"

#define NUMBER_OF_INPUTS 64
#define NUMBER_OF_OUTPUTS 10
#define TENSOR_ARENA_SIZE 8*1024

Eloquent::TinyML::TfLite<NUMBER_OF_INPUTS, NUMBER_OF_OUTPUTS, TENSOR_ARENA_SIZE> ml;

void setup() {
    Serial.begin(115200);
    ml.begin(digits_model);
}

void loop() {
    // a random sample from the MNIST dataset (precisely the last one)
    float x_test[64] = { 0., 0. , 0.625 , 0.875 , 0.5   , 0.0625, 0. , 0. ,
                    0. , 0.125 , 1. , 0.875 , 0.375 , 0.0625, 0. , 0. ,
                    0. , 0. , 0.9375, 0.9375, 0.5   , 0.9375, 0. , 0. ,
                    0. , 0. , 0.3125, 1. , 1. , 0.625 , 0. , 0. ,
                    0. , 0. , 0.75  , 0.9375, 0.9375, 0.75  , 0. , 0. ,
                    0. , 0.25  , 1. , 0.375 , 0.25  , 1. , 0.375 , 0. ,
                    0. , 0.5   , 1. , 0.625 , 0.5   , 1. , 0.5   , 0. ,
                    0. , 0.0625, 0.5   , 0.75  , 0.875 , 0.75  , 0.0625, 0. };
    // the output vector for the model predictions
    float y_pred[10] = {0};
    // the actual class of the sample
    int y_test = 8;

    // let's see how long it takes to classify the sample
    uint32_t start = micros();

    ml.predict(x_test, y_pred);

    uint32_t timeit = micros() - start;

    Serial.print("It took ");
    Serial.print(timeit);
    Serial.println(" micros to run inference");

    // let's print the raw predictions for all the classes
    // these values are not directly interpretable as probabilities!
    Serial.print("Test output is: ");
    Serial.println(y_test);
    Serial.print("Predicted proba are: ");

    for (int i = 0; i < 10; i++) {
        Serial.print(y_pred[i]);
        Serial.print(i == 9 ? '\n' : ',');
    }

    // let's print the "most probable" class
    // you can either use probaToClass() if you also want to use all the probabilities
    Serial.print("Predicted class is: ");
    Serial.println(ml.probaToClass(y_pred));
    // or you can skip the predict() method and call directly predictClass()
    Serial.print("Sanity check: ");
    Serial.println(ml.predictClass(x_test));

    delay(1000);
}</code></pre><p>That's it: if everything went fine, you should see that the predicted class is <code>8</code>.</p><h3 id="toccnn-on-arduino-and-stm32-figures">CNN on Arduino and STM32 figures</h3><p>I'll report the figures I get for compiling and running this project on the two boards I used.</p><table><thead><tr><th>Board</th><th style="text-align: right;">Flash</th><th style="text-align: right;">RAM</th><th style="text-align: right;">Inference time</th></tr></thead><tbody><tr><td>Nucleus  L432KC</td><td style="text-align: right;">154560</td><td style="text-align: right;">not available*</td><td style="text-align: right;">7187</td></tr><tr><td>Arduino Nano 33 BLE Sense</td><td style="text-align: right;">197656</td><td style="text-align: right;">56160</td><td style="text-align: right;">9400</td></tr></tbody></table><p><em>I used the Grumpyoldpizza compiler for the Nucleus, which doesn't report back the RAM usage</em></p><h2 id="tocand-you">And you?</h2><p>Were you able to deploy a CNN to your microcontroller thanks to this tutorial? Or are you having troubles?</p><p>Let me know in the comment and I will help you or share your experience with us.</p><hr><p>You can find the whole code on <a href="https://github.com/eloquentarduino/EloquentTinyML/tree/master/examples/DigitsExample">Github</a>.</p></div><div class="heateorSssClear"></div><div class="heateor_sss_sharing_container heateor_sss_horizontal_sharing" heateor-sss-data-href="https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/"><div class="heateor_sss_sharing_title" style="font-weight:bold">Help the blow grow</div><ul class="heateor_sss_sharing_ul"><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" alt="Facebook" title="Facebook" class="heateorSssSharing heateorSssFacebookBackground" onclick='heateorSssPopup("https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Feloquent.blog%2F2020%2F11%2Ftinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example%2F")'><ss style="display:block;border-radius:999px;" class="heateorSssSharingSvg heateorSssFacebookSvg"></ss></i></li><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" alt="Twitter" title="Twitter" class="heateorSssSharing heateorSssTwitterBackground" onclick='heateorSssPopup("http://twitter.com/intent/tweet?via=ArduinoEloquent&text=TinyML%20on%20Arduino%20and%20STM32%3A%20CNN%20%28Convolutional%20Neural%20Network%29%20example&url=http%3A%2F%2Feloquent.blog%2F2020%2F11%2Ftinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example%2F")'><ss style="display:block;border-radius:999px;" class="heateorSssSharingSvg heateorSssTwitterSvg"></ss></i></li><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" alt="Linkedin" title="Linkedin" class="heateorSssSharing heateorSssLinkedinBackground" onclick='heateorSssPopup("http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Feloquent.blog%2F2020%2F11%2Ftinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example%2F&title=TinyML%20on%20Arduino%20and%20STM32%3A%20CNN%20%28Convolutional%20Neural%20Network%29%20example")'><ss style="display:block;border-radius:999px;" class="heateorSssSharingSvg heateorSssLinkedinSvg"></ss></i></li><li class="heateorSssSharingRound"><i style="width:35px;height:35px;border-radius:999px;" title="More" alt="More" class="heateorSssSharing heateorSssMoreBackground" onclick="heateorSssMoreSharingPopup(this, 'https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/', 'TinyML%20on%20Arduino%20and%20STM32%3A%20CNN%20%28Convolutional%20Neural%20Network%29%20example', 'TinyML%20on%20Arduino%20and%20STM32%3A%20CNN%20%28Convolutional%20Neural%20Network%29%20example' )"><ss style="display:block" class="heateorSssSharingSvg heateorSssMoreSvg"></ss></i></li></ul><div class="heateorSssClear"></div></div><div class="heateorSssClear"></div><div class="heateor_sss_sharing_container heateor_sss_vertical_sharing heateor_sss_bottom_sharing" style="width:44px;right: -10px;top: 100px;-webkit-box-shadow:none;box-shadow:none;" heateor-sss-data-href="https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/"><ul class="heateor_sss_sharing_ul"><li class=""><i style="width:40px;height:40px;margin:0;" alt="Facebook" title="Facebook" class="heateorSssSharing heateorSssFacebookBackground" onclick='heateorSssPopup("https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Feloquent.blog%2F2020%2F11%2Ftinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example%2F")'><ss style="display:block;" class="heateorSssSharingSvg heateorSssFacebookSvg"></ss></i></li><li class=""><i style="width:40px;height:40px;margin:0;" alt="Twitter" title="Twitter" class="heateorSssSharing heateorSssTwitterBackground" onclick='heateorSssPopup("http://twitter.com/intent/tweet?via=ArduinoEloquent&text=TinyML%20on%20Arduino%20and%20STM32%3A%20CNN%20%28Convolutional%20Neural%20Network%29%20example&url=http%3A%2F%2Feloquent.blog%2F2020%2F11%2Ftinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example%2F")'><ss style="display:block;" class="heateorSssSharingSvg heateorSssTwitterSvg"></ss></i></li><li class=""><i style="width:40px;height:40px;margin:0;" title="More" alt="More" class="heateorSssSharing heateorSssMoreBackground" onclick="heateorSssMoreSharingPopup(this, 'https://eloquentarduino.github.io/2020/11/tinyml-on-arduino-and-stm32-cnn-convolutional-neural-network-example/', 'TinyML%20on%20Arduino%20and%20STM32%3A%20CNN%20%28Convolutional%20Neural%20Network%29%20example', 'TinyML%20on%20Arduino%20and%20STM32%3A%20CNN%20%28Convolutional%20Neural%20Network%29%20example' )"><ss style="display:block" class="heateorSssSharingSvg heateorSssMoreSvg"></ss></i></li></ul><div class="heateorSssClear"></div></div><div class="crp_related  "><h3>Related Posts</h3><ul><li><a href="https://eloquentarduino.github.io/2020/08/the-ultimate-guide-to-wifi-indoor-positioning-using-arduino-and-machine-learning/" class="post-1237"><span class="crp_title">The Ultimate Guide to Wifi Indoor Positioning using Arduino and Machine Learning</span></a></li></ul><div class="crp_clear"></div></div><div id="disqus_thread"></div></div><div class="clear"></div></div></div></div><div class="post-meta-bottom"><div class="post-cat-tags"><p class="post-categories"><span>Categories:</span> <a href="https://eloquentarduino.github.io/category/senza-categoria/" rel="category tag">Senza categoria</a></p></div><div class="archive-nav post-nav"> <a class="post-nav-older" title="Previous post: Decision Tree, Random Forest and XGBoost on Arduino" href="https://eloquentarduino.github.io/2020/10/decision-tree-random-forest-and-xgboost-on-arduino/"> « Decision Tree, Random Forest and XGBoost on Arduino </a><div class="clear"></div></div></div><p class="nocomments">Comments are closed.</p><div class="footer section large-padding bg-dark"><div class="clear"></div></div><div class="credits"><div class="credits-inner"><p class="credits-left">© 2020 <a href="https://eloquentarduino.github.io" title="Eloquent Arduino Blog">Eloquent Arduino Blog</a></p><p class="credits-right"><span>Theme by <a href="https://www.andersnoren.se">Anders Norén</a></span> — <a title="To the top" class="tothetop">Up ↑</a></p><div class="clear"></div></div></div></div><div class="clear"></div></div> <script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script> <script src="//cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-154550080-1"></script> <script>if (window.location.href.indexOf("eloquent.blog") < 0) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154550080-1');
}</script>  <script>(function() {
setTimeout(function() {
  var d = document, s = d.createElement('script');
  s.src = 'https://eloquent-arduino.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);},
10000);
})();</script>  <noscript><style>.lazyload{display:none;}</style></noscript><script data-noptimize="1">window.lazySizesConfig=window.lazySizesConfig||{};window.lazySizesConfig.loadMode=1;</script><script async data-noptimize="1" src="https://eloquentarduino.github.io/wp-content/plugins/autoptimize/classes/external/js/lazysizes.min.js"></script><link rel="stylesheet" id="fontawesome5-css" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" type="text/css" media="all"> <script type="text/javascript">function heateorSssLoadEvent(e) {var t=window.onload;if (typeof window.onload!="function") {window.onload=e}else{window.onload=function() {t();e()}}};	var heateorSssSharingAjaxUrl = 'https://eloquentarduino.github.io/wp-admin/admin-ajax.php', heateorSssCloseIconPath = 'https://eloquentarduino.github.io/wp-content/plugins/sassy-social-share/public/../images/close.png', heateorSssPluginIconPath = 'https://eloquentarduino.github.io/wp-content/plugins/sassy-social-share/public/../images/logo.png', heateorSssHorizontalSharingCountEnable = 0, heateorSssVerticalSharingCountEnable = 0, heateorSssSharingOffset = -10; var heateorSssMobileStickySharingEnabled = 1;var heateorSssCopyLinkMessage = "Link copied.";var heateorSssUrlCountFetched = [], heateorSssSharesText = 'Shares', heateorSssShareText = 'Share';function heateorSssPopup(e) {window.open(e,"popUpWindow","height=400,width=600,left=400,top=100,resizable,scrollbars,toolbar=0,personalbar=0,menubar=no,location=no,directories=no,status")};var heateorSssWhatsappShareAPI = "web";</script> <script type="text/javascript" src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill.min.js"></script> <script type="text/javascript">( 'fetch' in window ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-fetch.min.js?ver=3.0.0">' + 'ipt>' );( document.contains ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-node-contains.min.js?ver=3.26.0-0">' + 'ipt>' );( window.FormData && window.FormData.prototype.keys ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-formdata.min.js?ver=3.0.12">' + 'ipt>' );( Element.prototype.matches && Element.prototype.closest ) || document.write( '<script src="https://eloquentarduino.github.io/wp-includes/js/dist/vendor/wp-polyfill-element-closest.min.js?ver=2.0.2">' + 'ipt>' );</script> <script type="text/javascript" src="https://eloquentarduino.github.io/wp-includes/js/dist/i18n.min.js"></script> <script type="text/javascript">var highlight_and_share = {"show_facebook":"1","show_twitter":"1","show_linkedin":"1","show_pinterest":"","show_email":"","show_xing":"","show_copy":"","show_whatsapp":"","twitter_username":"EloquentArduino","twitter_fa_class":"fa fa-twitter","facebook_fa_class":"fa fa-facebook","linkedin_fa_class":"fa fa-linkedin","pinterest_fa_class":"fa fa-pinterest","xing_fa_class":"fa fa-xing","whatsapp_fa_class":"fa fa-whatsapp","copy_fa_class":"fa fa-copy","email_fa_class":"fa fa-envelope","mobile":"","content":".has-content-area","tweet_text":"Tweet","facebook_text":"Share","linkedin_text":"LinkedIn","pinterest_text":"Pinterest","whatsapp_text":"WhatsApp","xing_text":"Xing","copy_text":"Copy","email_text":"E-mail","icons":"1","facebook_app_id":"2530754057166153","email_your_name_value":"","email_from_value":"","nonce":"591148a922","ajax_url":"https:\/\/eloquentarduino.github.io\/wp-admin\/admin-ajax.php","email_share":"Share This Post Via Email","email_subject":"Your Subject","email_your_name":"Your Name","email_send_email":"Send to Email Address","email_subject_text":"[Shared Post] %title%","email_from":"Your Email Address","email_send":"Send Email","email_cancel":"Cancel","email_close":"Close","email_loading":"https:\/\/eloquentarduino.github.io\/wp-content\/plugins\/highlight-and-share\/img\/loading.gif","email_subject_error":"You must fill in a subject.","email_email_to":"Send to Email Address is blank.","email_email_from":"Your email address is blank.","email_email_name":"Your name is blank.","email_sending":"Sending...","customizer_preview":""};</script> <script type="text/javascript">( function( domain, translations ) {
	var localeData = translations.locale_data[ domain ] || translations.locale_data.messages;
	localeData[""].domain = domain;
	wp.i18n.setLocaleData( localeData, domain );
} )( "highlight-and-share", { "locale_data": { "messages": { "": {} } } } );</script> <script defer src="https://eloquentarduino.github.io/wp-content/cache/autoptimize/js/autoptimize_405692bdfc4919582a6406afb9858fc1.js"></script></body></html>
